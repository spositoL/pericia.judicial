<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Financiamento Judicial | Dr. Lincoln Sposito</title>
    <meta name="description" content="Simulador online de amortização para perícia judicial. Calcule sistemas SAC, Price e SACRE.">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
</head>
<body>

    <nav class="navbar" style="background-color: #1a2a3a; padding: 15px 0; border-bottom: 2px solid #c5a059;">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center; max-width: 1100px; margin: 0 auto; padding: 0 20px;">
            <div class="logo-wrapper">
                <a href="index.html" style="text-decoration: none; display: block; width: 220px;">
                    <img src="grafico.svg" width="220" height="60" alt="Logo Dr. Lincoln Sposito">
                </a>                
            </div>
            <a href="index.html" class="btn-primary">Voltar ao Início</a>
        </div>
    </nav>  

    <header class="hero-subpage" style="padding: 40px 0; background: var(--bg-light); border-bottom: 1px solid #ddd;">
        <div class="container">
            <h1>Calculadora de Amortização e Financiamento</h1>
            <p>Ferramenta técnica para análise de contratos e verificação de encargos financeiros.</p>
        </div>
    </header>

    <section class="calc-section" style="padding: 50px 0;">
        <div class="container">
            <div class="calc-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                
                <div class="calc-inputs" style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h2 style="font-size: 1.5rem; margin-bottom: 20px;">Parâmetros do Cálculo</h2>
                    
                    <div class="input-group">
                        <label>Sistema de Amortização</label>
                        <select id="sistema" class="form-control">
                            <option value="price" selected>Amortização Crescente (Price)</option>
                            <option value="sac">Amortização Constante (SAC)</option>
                            <option value="sacre">Amortização Híbrida (SACRE)</option>
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group"><label>Valor do Bem</label><input type="text" id="valorBem" class="mask-money" value="0,00" oninput="calcularFinanciamento()"></div>
                        <div class="input-group"><label>Entrada</label><input type="text" id="valorEntrada" class="mask-money" value="0,00" oninput="calcularFinanciamento()"></div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group"><label>Financiamento (Principal)</label><input type="text" id="valorPrincipal" class="mask-money" value="0,00" oninput="calcularTotalFinanciado()"></div>
                        <div class="input-group"><label>Total Despesas</label><input type="text" id="despesas" class="mask-money" value="0,00" oninput="calcularTotalFinanciado()"></div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group"><label>Total (Principal + Desp)</label><input type="text" id="valorTotal" class="mask-money" value="0,00" style="background: #f0f4f8; font-weight: bold;"></div>
                        <div class="input-group">
							<label id="labelParcela">Valor da Parcela (Informado)</label>
							<input type="text" id="valorParcelaInformado" class="mask-money" placeholder="Ex: 9333,33">
						</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group"><label>Taxa Nominal (% a.m.)</label><input type="text" id="taxaNominal" class="mask-percent" value="2,0000000000"></div>
                        <div class="input-group"><label>Taxa Efetiva (% a.m.)</label><input type="text" id="taxaEfetiva" class="mask-percent" value="2,0000000000"></div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group"><label>Nº de Parcelas</label><input type="number" id="parcelas" value="1" min="1"></div>
                        <div class="input-group"><label>Carência (Dias)</label><input type="text" id="carencia" readonly style="background: #f8f9fa;"></div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group"><label>Data Contrato</label><input type="date" id="dataCelebracao" onchange="calcularCarencia()"></div>
                        <div class="input-group"><label>1º Vencimento</label><input type="date" id="dataVencimento" onchange="calcularCarencia()"></div>
                    </div>
					
					<div class="input-group" style="margin-top: 20px; background: #fff9e6; padding: 15px; border-radius: 8px; border: 1px solid #c5a059;">
						<label style="color: #1a2a3a; font-weight: bold;">Tipo de Simulação:</label>
						<div style="display: flex; gap: 20px; margin-top: 10px;">
							<label style="font-weight: normal; cursor: pointer;">
								<input type="radio" name="tipoVisao" value="banco" checked> Plano do Banco (Dados Informados)
							</label>
							<label style="font-weight: normal; cursor: pointer;">
								<input type="radio" name="tipoVisao" value="revisado"> Plano Revisado (Cálculo Pericial)
							</label>
						</div>
					</div>					

                    <button onclick="processarCalculo()" class="btn-primary" style="width: 100%; margin-top: 20px; padding: 15px;">Gerar Tabela e Insights</button>
                </div>

                <div class="calc-sidebar">
                    <div class="info-box">
                        <h3>Como funciona?</h3>
                        <p>Esta ferramenta identifica divergências entre o contratado e o aplicado matematicamente.</p>
                        <ul style="padding-left: 20px; font-size: 0.9rem;">
                            <li><a href="#artigo-price">O que considerar no Sistema Price?</a></li>
                            <li><a href="#artigo-sac">Vantagens da Amortização SAC</a></li>
                            <li><a href="#artigo-sacre">Entenda a Amortização Híbrida</a></li>
                        </ul>
                    </div>
                    <div id="chatbase-integration" style="border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <p style="font-size: 0.8rem; color: #666;">Dúvidas técnicas? Pergunte ao nosso assistente.</p>
                    </div>
                </div>
            </div>

            <div id="resultado-area" style="margin-top: 50px; display: none; background: #fff; padding: 30px; border: 1px solid #ddd; border-radius: 8px;">
                <div id="cabecalho-laudo" style="text-align: center; margin-bottom: 30px;">
                    <img src="grafico.svg" alt="Dr. Lincoln Sposito" style="width: 250px; height: auto;">
                    <h2 style="color: #1a2a3a; margin-top: 15px;">Análise Técnica de Amortização</h2>
                    <p style="color: #666;">Perícia Judicial e Assistência Técnica</p>
                </div>
                
                <div id="insights-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;"></div>
                
                <div id="resumo-financeiro"></div>
                
                <div class="table-container" style="overflow-x: auto;">
                    <table id="tabela-amortizacao" class="table-pericia" style="width: 100%; border-collapse: collapse;"></table>
                </div>
                
                <div id="cta-final"></div>
            </div>
        </div>
    </section>

    <style>
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: 5px; color: var(--primary); }
        .form-control, input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .info-box { background: #eef2f7; padding: 20px; border-radius: 8px; border-left: 5px solid var(--accent); }
        .table-pericia th { background: #1a2a3a; color: white; padding: 12px; text-align: left; border: 1px solid #ddd; }
        .table-pericia td { padding: 10px; border: 1px solid #ddd; font-size: 0.9rem; text-align: right; }
    </style>

	<!-- ESTE SCRIPT FUNCIONAVA ANTES DA IMPLEMENTAÇÃO DA VALIDAÇÃO DO CET-->
	<script>
			// --- 1. FUNÇÕES DE INTERFACE E MÁSCARAS ---
			window.onload = function() {
				const hoje = new Date();
				const vencimento = new Date();
				vencimento.setDate(hoje.getDate() + 30);
				document.getElementById('dataCelebracao').value = hoje.toISOString().split('T')[0];
				document.getElementById('dataVencimento').value = vencimento.toISOString().split('T')[0];
				calcularCarencia();
			};

			function parseMoeda(v) { return parseFloat(v.replace(/\./g, '').replace(',', '.')) || 0; }
			function parsePercentual(v) { 
				if(!v) return 0;
				let limpo = v.replace('%', '').trim().replace(/\./g, '').replace(',', '.');
				return parseFloat(limpo) || 0; 
			}
			function formatarMoeda(v) { return v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

			function calcularFinanciamento() {
				const principal = Math.max(0, parseMoeda(document.getElementById('valorBem').value) - parseMoeda(document.getElementById('valorEntrada').value));
				document.getElementById('valorPrincipal').value = formatarMoeda(principal);
				calcularTotalFinanciado();
			}

			function calcularTotalFinanciado() {
				const total = parseMoeda(document.getElementById('valorPrincipal').value) + parseMoeda(document.getElementById('despesas').value);
				document.getElementById('valorTotal').value = formatarMoeda(total);
			}

			function calcularCarencia() {
				const d1 = new Date(document.getElementById('dataCelebracao').value);
				const d2 = new Date(document.getElementById('dataVencimento').value);
				if (d1 && d2) document.getElementById('carencia').value = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));
			}

			document.querySelectorAll('.mask-money').forEach(i => i.addEventListener('blur', function() { this.value = formatarMoeda(parseMoeda(this.value)); }));
			document.querySelectorAll('.mask-percent').forEach(i => i.addEventListener('blur', function() { 
				let v = parsePercentual(this.value);
				this.value = v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 10 }) + '%'; 
			}));
			
			document.getElementById('sistema').addEventListener('change', function() {
				const label = document.getElementById('labelParcela');
				const avisoArea = document.getElementById('chatbase-integration');
				if (this.value === 'price') {
					label.innerHTML = 'Valor da Parcela Fixa (Contrato)';
					if(avisoArea) avisoArea.innerHTML = '<p style="font-size: 0.8rem; color: #666;">Sistema Price: Prestações constantes.</p>';
				} else if (this.value === 'sac') {
					label.innerHTML = 'Valor da <strong>1ª Parcela</strong> (Contrato)';
					if(avisoArea) avisoArea.innerHTML = '<p style="font-size: 0.8rem; color: #666;">Sistema SAC: Amortização constante.</p>';
				} else if (this.value === 'sacre') {
					label.innerHTML = 'Valor da <strong>1ª Parcela</strong> (Contrato)';
					if(avisoArea) avisoArea.innerHTML = '<div style="background:#e7f3ff; color:#0056b3; padding:10px; border-radius:5px; font-size:0.8rem;"><strong>Nota BACEN:</strong> O SACRE utiliza projeção de inflação fixa em 4% a.a. para fins de auditoria pericial.</div>';
				}
			});

			// --- 2. MOTOR DE CÁLCULO (DISPATCHER) ---
			function processarCalculo() {
				try {
					const sistema = document.getElementById('sistema').value;
					const visao = document.querySelector('input[name="tipoVisao"]:checked').value;
					const p = {
						n: parseInt(document.getElementById('parcelas').value),
						iNom: parsePercentual(document.getElementById('taxaNominal').value) / 100,
						pvPrin: parseMoeda(document.getElementById('valorPrincipal').value),
						desp: parseMoeda(document.getElementById('despesas').value),
						pmtInfo: parseMoeda(document.getElementById('valorParcelaInformado').value)
					};
					p.pvTotal = p.pvPrin + p.desp;
					
					if (p.pvTotal <= 0 || p.n <= 0 || p.iNom <= 0) { alert("Dados incompletos."); return; }

					const cetCalculado = calcularCET_Real(p, sistema.toUpperCase());
					const cetInformado = parsePercentual(document.getElementById('taxaEfetiva').value) / 100;

					let auditoriaBanco, planoRevisado;

					if (sistema === 'price') {
						auditoriaBanco = motorPrice(p, 'banco');
						planoRevisado = motorPrice(p, 'revisado');
						renderizarLaudoUnificado(auditoriaBanco, planoRevisado, p, visao, "PRICE", cetCalculado, cetInformado);
					} 
					else if (sistema === 'sac') {
						auditoriaBanco = motorSAC(p, 'banco');
						planoRevisado = motorSAC(p, 'revisado');
						renderizarLaudoUnificado(auditoriaBanco, planoRevisado, p, visao, "SAC", cetCalculado, cetInformado);
					} 
					else if (sistema === 'sacre') {
						auditoriaBanco = motorSACRE(p, 'banco');
						planoRevisado = motorSACRE(p, 'revisado');
						renderizarLaudoUnificado(auditoriaBanco, planoRevisado, p, visao, "SACRE", cetCalculado, cetInformado);
					}

				} catch (e) { console.error(e); }
			}

			// --- 3. ENCAPSULAMENTO PRICE ---
			function motorPrice(p, tipo) {
				let pmtCorreta = p.pvTotal * ( (p.iNom * Math.pow(1 + p.iNom, p.n)) / (Math.pow(1 + p.iNom, p.n) - 1) );
				let pmtUso = (tipo === 'banco' && p.pmtInfo > 0) ? p.pmtInfo : pmtCorreta;
				let saldo = p.pvTotal, tPmt = 0, tJur = 0, tAmort = 0, tabela = [];

				for (let i = 1; i <= p.n; i++) {
					let jur = saldo * p.iNom;
					let amort = pmtUso - jur;
					saldo -= amort;
					tPmt += pmtUso; tJur += jur; tAmort += amort;
					tabela.push({ n: i, pmt: pmtUso, jur: jur, amort: amort, saldo: saldo });
				}
				return { tabela, pmtRef: pmtCorreta, tPmt, tJur, tAmort, saldoFinal: saldo };
			}

			// --- 4. ENCAPSULAMENTO SAC ---
			function motorSAC(p, tipo) {
				const amortConstante = p.pvTotal / p.n;
				const pmtPrimeiraCorreta = amortConstante + (p.pvTotal * p.iNom);
				const decrescimoMensal = amortConstante * p.iNom;
				let pmtBase = (tipo === 'banco' && p.pmtInfo > 0) ? p.pmtInfo : pmtPrimeiraCorreta;
				let saldo = p.pvTotal, tPmt = 0, tJur = 0, tAmort = 0, tabela = [];

				for (let i = 1; i <= p.n; i++) {
					let jur = saldo * p.iNom;
					let pmtNoMes = pmtBase - (decrescimoMensal * (i - 1));
					let amort = pmtNoMes - jur;
					saldo -= amort;
					tPmt += pmtNoMes; tJur += jur; tAmort += amort;
					tabela.push({ n: i, pmt: pmtNoMes, jur: jur, amort: amort, saldo: saldo });
				}
				return { tabela, pmtRef: pmtPrimeiraCorreta, tPmt, tJur, tAmort, saldoFinal: saldo };
			}

			// --- 5. ENCAPSULAMENTO SACRE (AUDITORIA PERICIAL) ---
			// --- 5. ENCAPSULAMENTO SACRE (ALINHADO COM EXCEL PERICIAL) ---
			function motorSACRE(p, tipo) {
				// Fator exato do Excel para evitar desvios: 1,00327374
				const inflacaoMensal = 0.00327374; 
				let saldo = p.pvTotal;
				let tPmt = 0, tJur = 0, tAmort = 0, tabela = [];

				// Cálculo da 1ª Parcela Técnica (Referência)
				let primeiroSaldoCM = p.pvTotal * (1 + inflacaoMensal);
				let pmtTecnica = (primeiroSaldoCM / p.n) + (primeiroSaldoCM * p.iNom);

				for (let i = 1; i <= p.n; i++) {
					let prazoRemanescente = p.n - i + 1;
					let saldoCorrigido = saldo * (1 + inflacaoMensal);
					let jur = saldoCorrigido * p.iNom;
					
					let pmtAtual;
					if (tipo === 'banco' && i === 1 && p.pmtInfo > 0) {
						// No modo BANCO, respeitamos a entrada do usuário para testar a taxa
						pmtAtual = p.pmtInfo;
					} else {
						// No REVISADO ou a partir da 2ª do banco, segue o SACRE Estrito
						pmtAtual = (saldoCorrigido / prazoRemanescente) + jur;
					}

					let amort = pmtAtual - jur;
					saldo = saldoCorrigido - amort;

					tPmt += pmtAtual; tJur += jur; tAmort += amort;

					tabela.push({
						n: i,
						saldoCorrigido: saldoCorrigido,
						pmt: pmtAtual,
						jur: jur,
						amort: amort,
						saldo: Math.abs(saldo) < 0.01 ? 0 : saldo 
					});
				}

				return { 
					tabela, 
					pmtRef: pmtTecnica, 
					tPmt, 
					tJur, 
					tAmort, 
					saldoFinal: Math.abs(saldo) < 0.05 ? 0 : saldo 
				};
			}

			// --- 6. RENDERIZAÇÃO UNIFICADA (COM ATALHO PERICIAL E BYPASS SACRE) ---
			//function renderizarLaudoUnificado(banco, revisado, p, visao, nomeSistema) {
			function renderizarLaudoUnificado(banco, revisado, p, visao, nomeSistema, cetCalc, cetInfo) {
				const area = document.getElementById('resultado-area');
				area.style.display = 'block';
				
				// 1. CÁLCULOS DE AUDITORIA
				const saldoF_Abs = Math.abs(banco.saldoFinal);
				const taxaReal = calcularTaxaImplicita(p.pvTotal, p.pmtInfo, p.n, nomeSistema);
				const difCET = Math.abs(cetCalc - cetInfo);
				
				// 2. LÓGICA DE VALIDAÇÃO (ATALHO PERICIAL)
				let taxaDivergente;
				if (nomeSistema === "SACRE") {
					const diferencaParcela = Math.abs(p.pmtInfo - banco.pmtRef);
					taxaDivergente = diferencaParcela > 0.01; 
				} else {
					const diferencaTaxa = Math.abs(taxaReal - p.iNom);
					taxaDivergente = diferencaTaxa > 0.00001;
				}

				// 3. HIERARQUIA DE VEREDITOS E CORES
				let status, cor, msg;
				let labelResiduo = (nomeSistema === "SACRE") ? "SALDO RESIDUAL INFLACIONÁRIO" : "RESÍDUO EM ABERTO";

				if (cetInfo > 0 && difCET > 0.0001) {
					status = "INCONSISTÊNCIA DE CUSTO (CET)";
					cor = "#d9534f"; 
					msg = `Divergência Documental: O contrato declara CET de ${(cetInfo*100).toFixed(6)}%, mas o custo real apurado é de ${(cetCalc*100).toFixed(6)}%.`;
				} else if (taxaDivergente) {
					status = "PLANO INCORRETO / INCONSISTÊNCIA";
					cor = "#d9534f"; 
					msg = nomeSistema === "SACRE" 
						? `A 1ª parcela de R$ ${formatarMoeda(p.pmtInfo)} diverge do cálculo técnico para a taxa de ${(p.iNom*100).toFixed(4)}%.`
						: `A taxa nominal de ${(p.iNom*100).toFixed(4)}% não condiz matematicamente com a parcela de R$ ${formatarMoeda(p.pmtInfo)}.`;
				} else if (nomeSistema === "SACRE" && saldoF_Abs > 0.10) {
					status = "DIVERGÊNCIA DE RECOMPOSIÇÃO";
					cor = "#31708f"; 
					msg = "O plano apresenta saldo residual decorrente da meta de inflação projetada (4% a.a.).";
				} else if (saldoF_Abs > 0.10) {
					status = "PLANO INCORRETO";
					cor = "#d9534f";
					msg = "O fluxo de pagamentos informado é insuficiente para liquidar o saldo devedor no prazo contratado.";
				} else if (saldoF_Abs >= 0.05) {
					status = "PLANO ACEITÁVEL";
					cor = "#ffc107"; 
					msg = "O plano do banco possui oscilação mínima aceitável decorrente de arredondamentos.";
				} else {
					status = "PLANO VALIDADO";
					cor = "#28a745"; 
					msg = "O plano do banco apresenta conformidade técnica.";
				}

				const dadosExibir = (visao === 'banco') ? banco : revisado;
				const tituloVisao = (visao === 'banco') ? "Plano do Banco (Auditado)" : "Plano Revisado (Correto)";

				let tableHeader = `<th>Nº</th><th>Parcela</th><th>Juros</th><th>Amortização</th><th>Saldo</th>`;
				if (nomeSistema === "SACRE") {
					tableHeader = `<th>Nº</th><th>Saldo Corrigido (CM)</th><th>Parcela</th><th>Juros</th><th>Amortização</th><th>Saldo Final</th>`;
				}

				area.innerHTML = `
					<div id="laudo-container" style="border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow:hidden;">
						<div style="background-color: #1a2a3a; padding: 30px; border-bottom: 4px solid #c5a059; text-align: center; color: white;">
							<img src="https://spositol.github.io/pericia.judicial/grafico.svg" alt="Dr. Lincoln Sposito" style="width: 250px;">
							<h2 style="font-family: 'Playfair Display', serif; margin-top:10px;">Laudo Pericial: Sistema ${nomeSistema}</h2>
						</div>
						
						<div style="padding: 30px;">
							<div class="info-box" style="border-left: 8px solid ${cor}; background: #fdfdfd; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
								<h4 style="color: ${cor}; text-transform: uppercase; margin-top:0; font-weight:800;">${status}</h4>
								<p style="color: #333; font-size: 1.05rem;">${msg}</p>
								
								<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 15px 0;">
									<div><small>TOTAL PAGO (BANCO)</small><br><strong>R$ ${formatarMoeda(banco.tPmt)}</strong></div>
									<div><small>JUROS ACUMULADOS</small><br><strong>R$ ${formatarMoeda(banco.tJur)}</strong></div>
									<div><small>AMORTIZAÇÃO REAL</small><br><strong>R$ ${formatarMoeda(banco.tAmort)}</strong></div>
								</div>

								<p style="font-size: 0.95rem; line-height: 1.6; background: #f8f9fa; padding: 15px; border-radius: 4px; border: 1px solid #eee;">
									<strong>Parâmetros de Auditoria:</strong><br>
									<hr style="border:0; border-top: 1px solid #e0e0e0; margin: 8px 0;">
									• Parcela Informada (Banco): <strong>R$ ${formatarMoeda(p.pmtInfo)}</strong><br>
									• Parcela Revisada (Técnica): <strong>R$ ${formatarMoeda(banco.pmtRef)}</strong><br>
									<hr style="border:0; border-top: 1px solid #e0e0e0; margin: 8px 0;">
									• Taxa Nominal Contratada: <strong>${(p.iNom*100).toFixed(6)}%</strong><br>
									• Taxa Revisada (em função da parcela): <strong style="color:#d9534f;">${(taxaReal*100).toFixed(6)}%</strong><br>
									<hr style="border:0; border-top: 1px solid #e0e0e0; margin: 8px 0;">
									• CET Declarado: ${(cetInfo*100).toFixed(6)}%<br>
									• CET Pericial (em função do capital líquido): <strong>${(cetCalc*100).toFixed(6)}%</strong>
								</p>

								<p style="font-size: 1.1rem; margin-top: 15px; color: ${cor}; font-weight: bold;">
									${banco.saldoFinal < -0.01 ? `PAGAMENTO INDÉBITO DETECTADO: R$ ${formatarMoeda(Math.abs(banco.saldoFinal))}` : `${labelResiduo}: R$ ${formatarMoeda(banco.saldoFinal)}`}
								</p>
							</div>

							<h3 style="color: #1a2a3a; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">Exibindo: ${tituloVisao}</h3>
							<div class="table-container" style="overflow-x: auto;">
								<table class="table-pericia" style="width:100%; border-collapse: collapse;">
									<thead><tr>${tableHeader}</tr></thead>
									<tbody>
										${dadosExibir.tabela.map(it => {
											if (nomeSistema === "SACRE") {
												return `<tr>
													<td>${it.n}</td>
													<td style="background:#f0f7ff;">R$ ${formatarMoeda(it.saldoCorrigido)}</td>
													<td>R$ ${formatarMoeda(it.pmt)}</td>
													<td>R$ ${formatarMoeda(it.jur)}</td>
													<td>R$ ${formatarMoeda(it.amort)}</td>
													<td>R$ ${formatarMoeda(it.saldo)}</td>
												</tr>`;
											} else {
												return `<tr>
													<td>${it.n}</td>
													<td>R$ ${formatarMoeda(it.pmt)}</td>
													<td>R$ ${formatarMoeda(it.jur)}</td>
													<td>R$ ${formatarMoeda(it.amort)}</td>
													<td ${it.n === p.n && saldoF_Abs > 0.1 ? 'style="color:red; font-weight:bold;"' : ''}>R$ ${formatarMoeda(it.saldo)}</td>
												</tr>`;
											}
										}).join('')}
										<tr style="background:#f8f9fa; font-weight:bold;">
											<td>TOTAIS</td>
											${nomeSistema === "SACRE" ? "<td>---</td>" : ""}
											<td>R$ ${formatarMoeda(dadosExibir.tPmt)}</td>
											<td>R$ ${formatarMoeda(dadosExibir.tJur)}</td>
											<td>R$ ${formatarMoeda(dadosExibir.tAmort)}</td>
											<td>---</td>
										</tr>
									</tbody>
								</table>
							</div>
							<div id="cta-pericial" style="margin-top: 40px; padding: 30px; background: #fdf8ef; border: 2px dashed #c5a059; border-radius: 8px; text-align: center;">
								<h3 style="font-family: 'Playfair Display', serif; color: #1a2a3a; margin-bottom: 15px;">Deseja uma análise jurídica detalhada deste contrato?</h3>
								<p style="color: #666; margin-bottom: 25px;">Nossa equipe de especialistas em direito bancário pode ajudar você a recuperar valores pagos indevidamente.</p>
								<a href="https://wa.me/11914612603" target="_blank" class="btn-primary" style="padding: 15px 30px; text-decoration: none; font-weight: bold; border-radius:5px; display: inline-block;">Falar com Dr Lincoln agora</a>
							</div>                        
						</div>
					</div>`;
				area.scrollIntoView({ behavior: 'smooth' });
			}

			function calcularTaxaImplicita(pv, pmt, n, sistema) {
				if (sistema !== 'PRICE') {
					const amort = pv / n;
					return (pmt - amort) / pv;
				}
				let i = 0.01;
				for (let x = 0; x < 30; x++) {
					let f = pmt * (1 - Math.pow(1 + i, -n)) / i - pv;
					let df = pmt * (n * Math.pow(1 + i, -n - 1) * i - (1 - Math.pow(1 + i, -n))) / (i * i);
					i = i - f / (df || 1);
				}
				return i;
			}

			function calcularCET_Real(p, sistema) {
				const pvLiquido = p.pvPrin;
				const n = p.n;
				const iNom = p.iNom;
				const pvTotal = p.pvTotal;

				// Se for PRICE, usamos a fórmula de Newton-Raphson para parcelas fixas
				if (sistema === 'PRICE') {
					let i = 0.01;
					const pmt = p.pmtInfo;
					for (let x = 0; x < 40; x++) {
						let pot = Math.pow(1 + i, -n);
						let f = pmt * (1 - pot) / i - pvLiquido;
						let df = pmt * ((n * pot) / (i * (1 + i)) - (1 - pot) / (i * i));
						i = i - f / (df || 1);
					}
					return i;
				}

				// Se for SAC ou SACRE, iteramos sobre o fluxo decrescente real
				let iCET = 0.01; 
				const amortizacao = pvTotal / n;

				for (let x = 0; x < 60; x++) {
					let f = -pvLiquido;
					let df = 0;

					for (let t = 1; t <= n; t++) {
						// Reconstrói a parcela t do SAC/SACRE para confrontar com o valor líquido
						let saldoDevedorAnterior = pvTotal - (amortizacao * (t - 1));
						let pmt_t = amortizacao + (saldoDevedorAnterior * iNom);
						
						let pot = Math.pow(1 + iCET, -t);
						f += pmt_t * pot;
						df -= t * pmt_t * Math.pow(1 + iCET, -t - 1);
					}

					iCET = iCET - f / (df || 1);
					if (Math.abs(f) < 0.0000001) break; 
				}
				return iCET;
			}
	</script> 

</body>
</html>
<!-- 		function renderizarLaudoUnificado(banco, revisado, p, visao, nomeSistema, cetCalc, cetInfo) {
			const area = document.getElementById('resultado-area');
			area.style.display = 'block';
			
			// 1. CÁLCULOS DE AUDITORIA
			const saldoF_Abs = Math.abs(banco.saldoFinal);
			const taxaReal = calcularTaxaImplicita(p.pvTotal, p.pmtInfo, p.n, nomeSistema);
			const difCET = Math.abs(cetCalc - cetInfo);
			
			// 2. LÓGICA DE VALIDAÇÃO (ATALHO PERICIAL)
			let taxaDivergente;
			if (nomeSistema === "SACRE") {
				const diferencaParcela = Math.abs(p.pmtInfo - banco.pmtRef);
				taxaDivergente = diferencaParcela > 0.01; 
			} else {
				const diferencaTaxa = Math.abs(taxaReal - p.iNom);
				taxaDivergente = diferencaTaxa > 0.00001;
			}

			// 3. HIERARQUIA DE VEREDITOS E CORES
			let status, cor, msg;
			let labelResiduo = (nomeSistema === "SACRE") ? "SALDO RESIDUAL INFLACIONÁRIO" : "RESÍDUO EM ABERTO";

			if (cetInfo > 0 && difCET > 0.0001) {
				// REGRA: Vício de Informação (CET) - PRIORIDADE MÁXIMA
				status = "INCONSISTÊNCIA DE CUSTO (CET)";
				cor = "#d9534f"; 
				msg = `Divergência Documental: O contrato declara CET de ${(cetInfo*100).toFixed(6)}%, mas o custo real apurado pela perícia é de ${(cetCalc*100).toFixed(6)}%.`;

			} else if (taxaDivergente) {
				// REGRA: Erro na Taxa Nominal vs Parcela
				status = "PLANO INCORRETO / INCONSISTÊNCIA";
				cor = "#d9534f"; 
				msg = nomeSistema === "SACRE" 
					? `A 1ª parcela de R$ ${formatarMoeda(p.pmtInfo)} diverge do cálculo técnico para a taxa de ${(p.iNom*100).toFixed(4)}%.`
					: `A taxa nominal de ${(p.iNom*100).toFixed(4)}% não condiz matematicamente com a parcela de R$ ${formatarMoeda(p.pmtInfo)}.`;

			} else if (nomeSistema === "SACRE" && saldoF_Abs > 0.10) {
				// REGRA: Divergência de Recomposição (Azul Pericial)
				status = "DIVERGÊNCIA DE RECOMPOSIÇÃO";
				cor = "#31708f"; 
				msg = "O plano apresenta saldo residual decorrente da meta de inflação projetada (4% a.a.).";

			} 
			if (saldoF_Abs > 0.10) {
				// REGRA: Plano Incorreto (Price/SAC)
				status = "PLANO INCORRETO";
				cor = "#d9534f";
				msg = "O fluxo de pagamentos informado é insuficiente para liquidar o saldo devedor no prazo contratado.";

			} else if (saldoF_Abs >= 0.05) {
				// REGRA: Plano Aceitável (Amarelo)
				status = "PLANO ACEITÁVEL";
				cor = "#ffc107"; 
				msg = "O plano do banco possui oscilação mínima aceitável decorrente de arredondamentos.";

			} else {
				// REGRA: Plano Validado (Verde)
				status = "PLANO VALIDADO";
				cor = "#28a745"; 
				msg = "O plano do banco apresenta conformidade técnica.";
			}

			const dadosExibir = (visao === 'banco') ? banco : revisado;
			const tituloVisao = (visao === 'banco') ? "Plano do Banco (Auditado)" : "Plano Revisado (Correto)";

			let tableHeader = `<th>Nº</th><th>Parcela</th><th>Juros</th><th>Amortização</th><th>Saldo</th>`;
			if (nomeSistema === "SACRE") {
				tableHeader = `<th>Nº</th><th>Saldo Corrigido (CM)</th><th>Parcela</th><th>Juros</th><th>Amortização</th><th>Saldo Final</th>`;
			}

			area.innerHTML = `
				<div id="laudo-container" style="border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow:hidden;">
					<div style="background-color: #1a2a3a; padding: 30px; border-bottom: 4px solid #c5a059; text-align: center; color: white;">
						<img src="https://spositol.github.io/pericia.judicial/grafico.svg" alt="Dr. Lincoln Sposito" style="width: 250px;">
						<h2 style="font-family: 'Playfair Display', serif; margin-top:10px;">Laudo Pericial: Sistema ${nomeSistema}</h2>
					</div>
					
					<div style="padding: 30px;">
						<div class="info-box" style="border-left: 8px solid ${cor}; background: #fdfdfd; padding: 25px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
							<h4 style="color: ${cor}; text-transform: uppercase; margin-top:0; font-weight:800;">${status}</h4>
							<p style="color: #333; font-size: 1.05rem;">${msg}</p>
							
							<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 15px 0;">
								<div><small>TOTAL PAGO (BANCO)</small><br><strong>R$ ${formatarMoeda(banco.tPmt)}</strong></div>
								<div><small>JUROS ACUMULADOS</small><br><strong>R$ ${formatarMoeda(banco.tJur)}</strong></div>
								<div><small>AMORTIZAÇÃO REAL</small><br><strong>R$ ${formatarMoeda(banco.tAmort)}</strong></div>
							</div>

							<p style="font-size: 0.95rem; line-height: 1.6; background: #f8f9fa; padding: 10px; border-radius: 4px;">
								<strong>Parâmetros de Auditoria:</strong><br>
								Taxa Nominal: ${(p.iNom*100).toFixed(6)}% | Taxa Real (Engenharia Reversa): ${(taxaReal*100).toFixed(6)}%<br>
								CET Declarado: ${(cetInfo*100).toFixed(6)}% | CET Pericial: ${(cetCalc*100).toFixed(6)}%
							</p>
							<p style="font-size: 1.1rem; margin-top: 15px; color: ${cor}; font-weight: bold;">
								${banco.saldoFinal < -0.01 ? `PAGAMENTO INDÉBITO DETECTADO: R$ ${formatarMoeda(Math.abs(banco.saldoFinal))}` : `${labelResiduo}: R$ ${formatarMoeda(banco.saldoFinal)}`}
							</p>
						</div>

						<h3 style="color: #1a2a3a; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">Exibindo: ${tituloVisao}</h3>
						<div class="table-container" style="overflow-x: auto;">
							<table class="table-pericia" style="width:100%; border-collapse: collapse;">
								<thead><tr>${tableHeader}</tr></thead>
								<tbody>
									${dadosExibir.tabela.map(it => {
										if (nomeSistema === "SACRE") {
											return `<tr>
												<td>${it.n}</td>
												<td style="background:#f0f7ff;">R$ ${formatarMoeda(it.saldoCorrigido)}</td>
												<td>R$ ${formatarMoeda(it.pmt)}</td>
												<td>R$ ${formatarMoeda(it.jur)}</td>
												<td>R$ ${formatarMoeda(it.amort)}</td>
												<td>R$ ${formatarMoeda(it.saldo)}</td>
											</tr>`;
										} else {
											return `<tr>
												<td>${it.n}</td>
												<td>R$ ${formatarMoeda(it.pmt)}</td>
												<td>R$ ${formatarMoeda(it.jur)}</td>
												<td>R$ ${formatarMoeda(it.amort)}</td>
												<td ${it.n === p.n && saldoF_Abs > 0.1 ? 'style="color:red; font-weight:bold;"' : ''}>R$ ${formatarMoeda(it.saldo)}</td>
											</tr>`;
										}
									}).join('')}
									<tr style="background:#f8f9fa; font-weight:bold;">
										<td>TOTAIS</td>
										${nomeSistema === "SACRE" ? "<td>---</td>" : ""}
										<td>R$ ${formatarMoeda(dadosExibir.tPmt)}</td>
										<td>R$ ${formatarMoeda(dadosExibir.tJur)}</td>
										<td>R$ ${formatarMoeda(dadosExibir.tAmort)}</td>
										<td>---</td>
									</tr>
								</tbody>
							</table>
						</div>
						<div id="cta-pericial" style="margin-top: 40px; padding: 30px; background: #fdf8ef; border: 2px dashed #c5a059; border-radius: 8px; text-align: center;">
							<h3 style="font-family: 'Playfair Display', serif; color: #1a2a3a; margin-bottom: 15px;">Deseja uma análise jurídica detalhada deste contrato?</h3>
							<p style="color: #666; margin-bottom: 25px;">Nossa equipe de especialistas em direito bancário pode ajudar você a recuperar valores pagos indevidamente.</p>
							<a href="https://wa.me/11914612603" target="_blank" style="background:#1a2a3a; color:white; padding:15px 30px; text-decoration:none; font-weight:bold; border-radius:5px; display: inline-block;">Falar com Dr Lincoln agora</a>
						</div>                        
					</div>
				</div>`;
			area.scrollIntoView({ behavior: 'smooth' });
		}	
-->
<!--function renderizarLaudoUnificado(banco, revisado, p, visao, nomeSistema, cetCalc, cetInfo) {
			const area = document.getElementById('resultado-area');
			area.style.display = 'block';
			
			const saldoF_Abs = Math.abs(banco.saldoFinal);
			const taxaReal = calcularTaxaImplicita(p.pvTotal, p.pmtInfo, p.n, nomeSistema);
			const difCET = Math.abs(cetCalc - cetInfo);
			
			// LÓGICA DE VALIDAÇÃO (ATALHO PERICIAL)
			let taxaDivergente;
			
			if (nomeSistema === "SACRE") {
				// No SACRE, comparamos a 1ª Parcela (Bypass de contaminação por CM)
				const diferencaParcela = Math.abs(p.pmtInfo - banco.pmtRef);
				taxaDivergente = diferencaParcela > 0.01; // Tolerância de 1 centavo
			} else {
				// Para PRICE e SAC, mantém a comparação rigorosa de Taxa Nominal
				const diferencaTaxa = Math.abs(taxaReal - p.iNom);
				taxaDivergente = diferencaTaxa > 0.00001;
			}

			let status = "INCONSISTÊNCIA DETECTADA", cor = "#d9534f", msg = "O plano do banco é matematicamente INCORRETO.";
			let labelResiduo = "RESÍDUO EM ABERTO";

			// Lógica de Veredito Reestruturada
			// NOVO BLOCO DE VEREDITO CET
			if (cetInfo > 0 && difCET > 0.0001) {
				status = "INCONSISTÊNCIA DE CUSTO (CET)";
				cor = "#d9534f";
				msg = `Divergência Documental: O contrato declara CET de ${(cetInfo*100).toFixed(4)}%, mas o custo real (CET) apurado sobre o capital líquido é de ${(cetCalc*100).toFixed(4)}%.`;
			} else if (taxaDivergente) {
				status = "PLANO INCORRETO / INCONSISTÊNCIA";
				cor = "#d9534f";
				msg = nomeSistema === "SACRE" 
					? `A 1ª parcela de R$ ${formatarMoeda(p.pmtInfo)} diverge do cálculo técnico para a taxa de ${(p.iNom*100).toFixed(4)}%.`
					: `A taxa nominal de ${(p.iNom*100).toFixed(4)}% não condiz com a parcela de R$ ${formatarMoeda(p.pmtInfo)}.`;
			} else if (nomeSistema === "SACRE" && saldoF_Abs > 0.10) {
				status = "DIVERGÊNCIA DE RECOMPOSIÇÃO";
				cor = "#31708f"; 
				msg = "O plano apresenta saldo residual decorrente da meta de inflação projetada (4% a.a.).";
				labelResiduo = "SALDO RESIDUAL INFLACIONÁRIO";
			} else if (saldoF_Abs < 0.05) { 
				status = "PLANO VALIDADO"; 
				cor = "#28a745"; 
				msg = "O plano do banco apresenta conformidade técnica."; 
			} else if (saldoF_Abs < 0.10) { 
				status = "PLANO ACEITÁVEL"; 
				cor = "#ffc107"; 
				msg = "O plano do banco possui oscilação mínima aceitável."; 
			}

			// Blocos originais mantidos para Price e SAC
			const dadosExibir = (visao === 'banco') ? banco : revisado;
			const tituloVisao = (visao === 'banco') ? "Plano do Banco (Auditado)" : "Plano Revisado (Correto)";

			let tableHeader = `<th>Nº</th><th>Parcela</th><th>Juros</th><th>Amortização</th><th>Saldo</th>`;
			if (nomeSistema === "SACRE") {
				tableHeader = `<th>Nº</th><th>Saldo Corrigido (CM)</th><th>Parcela</th><th>Juros</th><th>Amortização</th><th>Saldo Final</th>`;
			}

			area.innerHTML = `
				<div id="laudo-container" style="border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow:hidden;">
					<div style="background-color: #1a2a3a; padding: 30px; border-bottom: 4px solid #c5a059; text-align: center; color: white;">
						<img src="https://spositol.github.io/pericia.judicial/grafico.svg" alt="Dr. Lincoln Sposito" style="width: 250px;">
						<h2 style="font-family: 'Playfair Display', serif; margin-top:10px;">Laudo Pericial: Sistema ${nomeSistema}</h2>
					</div>
					
					<div style="padding: 30px;">
						<div class="info-box" style="border-left: 8px solid ${cor}; background: #fff5f5; padding: 25px; margin-bottom: 30px;">
							<h4 style="color: ${cor}; text-transform: uppercase; margin-top:0;">${status}</h4>
							<p style="color: #333;">${msg}</p>
							
							<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; border-top: 1px solid #f2dede; border-bottom: 1px solid #f2dede; padding: 15px 0;">
								<div><small>TOTAL PAGO (BANCO)</small><br><strong>R$ ${formatarMoeda(banco.tPmt)}</strong></div>
								<div><small>JUROS ACUMULADOS</small><br><strong>R$ ${formatarMoeda(banco.tJur)}</strong></div>
								<div><small>AMORTIZAÇÃO REAL</small><br><strong>R$ ${formatarMoeda(banco.tAmort)}</strong></div>
							</div>

							<p style="font-size: 0.95rem; line-height: 1.6;">
								<strong>Análise de Parâmetros:</strong> Pela taxa de ${(p.iNom*100).toFixed(6)}%, a ${nomeSistema === 'PRICE' ? 'parcela' : '1ª parcela'} deveria ser <strong>R$ ${formatarMoeda(banco.pmtRef)}</strong>. 
								O valor informado projeta uma taxa real de <strong>${(taxaReal*100).toFixed(6)}% a.m.</strong>
							</p>
							<p style="font-size: 1.1rem; margin-top: 15px; color: ${cor}; font-weight: bold;">
								${banco.saldoFinal < -0.01 ? `PAGAMENTO INDÉBITO DETECTADO: R$ ${formatarMoeda(Math.abs(banco.saldoFinal))}` : `${labelResiduo}: R$ ${formatarMoeda(banco.saldoFinal)}`}
							</p>
						</div>

						<h3 style="color: #1a2a3a; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">Exibindo: ${tituloVisao}</h3>
						<div class="table-container" style="overflow-x: auto;">
							<table class="table-pericia" style="width:100%; border-collapse: collapse;">
								<thead><tr>${tableHeader}</tr></thead>
								<tbody>
									${dadosExibir.tabela.map(it => {
										if (nomeSistema === "SACRE") {
											return `<tr>
												<td>${it.n}</td>
												<td style="background:#f0f7ff;">R$ ${formatarMoeda(it.saldoCorrigido)}</td>
												<td>R$ ${formatarMoeda(it.pmt)}</td>
												<td>R$ ${formatarMoeda(it.jur)}</td>
												<td>R$ ${formatarMoeda(it.amort)}</td>
												<td>R$ ${formatarMoeda(it.saldo)}</td>
											</tr>`;
										} else {
											return `<tr>
												<td>${it.n}</td>
												<td>R$ ${formatarMoeda(it.pmt)}</td>
												<td>R$ ${formatarMoeda(it.jur)}</td>
												<td>R$ ${formatarMoeda(it.amort)}</td>
												<td ${it.n === p.n && saldoF_Abs > 0.1 ? 'style="color:red; font-weight:bold;"' : ''}>R$ ${formatarMoeda(it.saldo)}</td>
											</tr>`;
										}
									}).join('')}
									<tr style="background:#f8f9fa; font-weight:bold;">
										<td>TOTAIS</td>
										${nomeSistema === "SACRE" ? "<td>---</td>" : ""}
										<td>R$ ${formatarMoeda(dadosExibir.tPmt)}</td>
										<td>R$ ${formatarMoeda(dadosExibir.tJur)}</td>
										<td>R$ ${formatarMoeda(dadosExibir.tAmort)}</td>
										<td>---</td>
									</tr>
								</tbody>
							</table>
						</div>
						<div id="cta-pericial" style="margin-top: 40px; padding: 30px; background: #fdf8ef; border: 2px dashed #c5a059; border-radius: 8px; text-align: center;">
							<h3 style="font-family: 'Playfair Display', serif; color: #1a2a3a; margin-bottom: 15px;">Deseja uma análise jurídica detalhada deste contrato?</h3>
							<p style="color: #666; margin-bottom: 25px;">Nossa equipe de especialistas em direito bancário pode ajudar você a recuperar valores pagos indevidamente.</p>
							<a href="https://wa.me/11914612603" target="_blank" class="btn-primary" style="padding: 15px 30px; text-decoration: none; font-weight: bold; display: inline-block;">Falar com Dr Lincoln agora</a>
						</div>                        
					</div>
				</div>`;
			area.scrollIntoView({ behavior: 'smooth' });
		}
	-->

<!-- 	<script>
		// --- 1. FUNÇÕES DE INTERFACE E MÁSCARAS ---
		window.onload = function() {
			const hoje = new Date();
			const vencimento = new Date();
			vencimento.setDate(hoje.getDate() + 30);
			document.getElementById('dataCelebracao').value = hoje.toISOString().split('T')[0];
			document.getElementById('dataVencimento').value = vencimento.toISOString().split('T')[0];
			calcularCarencia();
		};

		function parseMoeda(v) { return parseFloat(v.replace(/\./g, '').replace(',', '.')) || 0; }
		function parsePercentual(v) { 
			if(!v) return 0;
			let limpo = v.replace('%', '').trim().replace(/\./g, '').replace(',', '.');
			return parseFloat(limpo) || 0; 
		}
		function formatarMoeda(v) { return v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

		function calcularFinanciamento() {
			const principal = Math.max(0, parseMoeda(document.getElementById('valorBem').value) - parseMoeda(document.getElementById('valorEntrada').value));
			document.getElementById('valorPrincipal').value = formatarMoeda(principal);
			calcularTotalFinanciado();
		}

		function calcularTotalFinanciado() {
			const total = parseMoeda(document.getElementById('valorPrincipal').value) + parseMoeda(document.getElementById('despesas').value);
			document.getElementById('valorTotal').value = formatarMoeda(total);
		}

		function calcularCarencia() {
			const d1 = new Date(document.getElementById('dataCelebracao').value);
			const d2 = new Date(document.getElementById('dataVencimento').value);
			if (d1 && d2) document.getElementById('carencia').value = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));
		}

		document.querySelectorAll('.mask-money').forEach(i => i.addEventListener('blur', function() { this.value = formatarMoeda(parseMoeda(this.value)); }));
		document.querySelectorAll('.mask-percent').forEach(i => i.addEventListener('blur', function() { 
			let v = parsePercentual(this.value);
			this.value = v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 10 }) + '%'; 
		}));
		
		document.getElementById('sistema').addEventListener('change', function() {
			const label = document.getElementById('labelParcela');
			const avisoArea = document.getElementById('chatbase-integration');
			if (this.value === 'price') {
				label.innerHTML = 'Valor da Parcela Fixa (Contrato)';
				if(avisoArea) avisoArea.innerHTML = '<p style="font-size: 0.8rem; color: #666;">Sistema Price: Prestações constantes.</p>';
			} else if (this.value === 'sac') {
				label.innerHTML = 'Valor da <strong>1ª Parcela</strong> (Contrato)';
				if(avisoArea) avisoArea.innerHTML = '<p style="font-size: 0.8rem; color: #666;">Sistema SAC: Amortização constante.</p>';
			} else if (this.value === 'sacre') {
				label.innerHTML = 'Valor da <strong>1ª Parcela</strong> (Contrato)';
				if(avisoArea) avisoArea.innerHTML = '<div style="background:#e7f3ff; color:#0056b3; padding:10px; border-radius:5px; font-size:0.8rem;"><strong>Nota BACEN:</strong> O SACRE utiliza projeção de inflação fixa em 4% a.a. para fins de auditoria pericial.</div>';
			}
		});

		// --- 2. MOTOR DE CÁLCULO (DISPATCHER) ---
		function processarCalculo() {
			try {
				const sistema = document.getElementById('sistema').value;
				const visao = document.querySelector('input[name="tipoVisao"]:checked').value;
				const p = {
					n: parseInt(document.getElementById('parcelas').value),
					iNom: parsePercentual(document.getElementById('taxaNominal').value) / 100,
					pvPrin: parseMoeda(document.getElementById('valorPrincipal').value),
					desp: parseMoeda(document.getElementById('despesas').value),
					pmtInfo: parseMoeda(document.getElementById('valorParcelaInformado').value)
				};
				p.pvTotal = p.pvPrin + p.desp;

				if (p.pvTotal <= 0 || p.n <= 0 || p.iNom <= 0) { alert("Dados incompletos."); return; }

				let auditoriaBanco, planoRevisado;

				if (sistema === 'price') {
					auditoriaBanco = motorPrice(p, 'banco');
					planoRevisado = motorPrice(p, 'revisado');
					renderizarLaudoUnificado(auditoriaBanco, planoRevisado, p, visao, "PRICE");
				} 
				else if (sistema === 'sac') {
					auditoriaBanco = motorSAC(p, 'banco');
					planoRevisado = motorSAC(p, 'revisado');
					renderizarLaudoUnificado(auditoriaBanco, planoRevisado, p, visao, "SAC");
				} 
				else if (sistema === 'sacre') {
					auditoriaBanco = motorSACRE(p, 'banco');
					planoRevisado = motorSACRE(p, 'revisado');
					renderizarLaudoUnificado(auditoriaBanco, planoRevisado, p, visao, "SACRE");
				}

			} catch (e) { console.error(e); }
		}

		// --- 3. ENCAPSULAMENTO PRICE ---
		function motorPrice(p, tipo) {
			let pmtCorreta = p.pvTotal * ( (p.iNom * Math.pow(1 + p.iNom, p.n)) / (Math.pow(1 + p.iNom, p.n) - 1) );
			let pmtUso = (tipo === 'banco' && p.pmtInfo > 0) ? p.pmtInfo : pmtCorreta;
			let saldo = p.pvTotal, tPmt = 0, tJur = 0, tAmort = 0, tabela = [];

			for (let i = 1; i <= p.n; i++) {
				let jur = saldo * p.iNom;
				let amort = pmtUso - jur;
				saldo -= amort;
				tPmt += pmtUso; tJur += jur; tAmort += amort;
				tabela.push({ n: i, pmt: pmtUso, jur, amort, saldo });
			}
			return { tabela, pmtRef: pmtCorreta, tPmt, tJur, tAmort, saldoFinal: saldo };
		}

		// --- 4. ENCAPSULAMENTO SAC ---
		function motorSAC(p, tipo) {
			const amortConstante = p.pvTotal / p.n;
			const pmtPrimeiraCorreta = amortConstante + (p.pvTotal * p.iNom);
			const decrescimoMensal = amortConstante * p.iNom;
			let pmtBase = (tipo === 'banco' && p.pmtInfo > 0) ? p.pmtInfo : pmtPrimeiraCorreta;
			let saldo = p.pvTotal, tPmt = 0, tJur = 0, tAmort = 0, tabela = [];

			for (let i = 1; i <= p.n; i++) {
				let jur = saldo * p.iNom;
				let pmtNoMes = pmtBase - (decrescimoMensal * (i - 1));
				let amort = pmtNoMes - jur;
				saldo -= amort;
				tPmt += pmtNoMes; tJur += jur; tAmort += amort;
				tabela.push({ n: i, pmt: pmtNoMes, jur, amort, saldo });
			}
			return { tabela, pmtRef: pmtPrimeiraCorreta, tPmt, tJur, tAmort, saldoFinal: saldo };
		}

		// --- 5. ENCAPSULAMENTO SACRE (COM PROJEÇÃO DE INFLAÇÃO 4% A.A.) ---
		function motorSACRE(p, tipo) {
			const inflacaoMensal = Math.pow(1 + 0.04, 1/12) - 1;
			const pmtPrimeiraTecnica = (p.pvTotal / p.n) + (p.pvTotal * p.iNom);
			let pmtBaseBanco = (tipo === 'banco' && p.pmtInfo > 0) ? p.pmtInfo : pmtPrimeiraTecnica;
			
			let saldo = p.pvTotal, tPmt = 0, tJur = 0, tAmort = 0, tabela = [];

			for (let i = 1; i <= p.n; i++) {
				// No SACRE, o saldo é corrigido antes do recálculo
				saldo = saldo * (1 + inflacaoMensal);
				let jur = saldo * p.iNom;
				let pmtNoMes;
				
				if (tipo === 'banco') {
					// Auditoria Banco: Aplica o decréscimo proporcional partindo do erro inicial
					const decrescimoRef = (p.pvTotal / p.n) * p.iNom;
					pmtNoMes = pmtBaseBanco - (decrescimoRef * (i - 1));
				} else {
					// Revisado: Recálculo puro SACRE pelo prazo remanescente
					pmtNoMes = (saldo / (p.n - i + 1)) + jur;
				}
				
				let amort = pmtNoMes - jur;
				saldo -= amort;
				tPmt += pmtNoMes; tJur += jur; tAmort += amort;
				tabela.push({ n: i, pmt: pmtNoMes, jur, amort, saldo });
			}
			return { tabela, pmtRef: pmtPrimeiraTecnica, tPmt, tJur, tAmort, saldoFinal: saldo };
		}

		// --- 6. RENDERIZAÇÃO UNIFICADA (MENSAGENS ORIGINAIS PRESERVADAS) ---
		function renderizarLaudoUnificado(banco, revisado, p, visao, nomeSistema) {
			const area = document.getElementById('resultado-area');
			area.style.display = 'block';
			
			const saldoF_Abs = Math.abs(banco.saldoFinal);
			const taxaReal = calcularTaxaImplicita(p.pvTotal, p.pmtInfo, p.n, nomeSistema);
			
			let status = "INCONSISTÊNCIA DETECTADA", cor = "#d9534f", msg = "O plano do banco é matematicamente INCORRETO.";
			if (saldoF_Abs < 0.005) { status = "PLANO VALIDADO"; cor = "#28a745"; msg = "O plano do banco apresenta conformidade técnica."; }
			else if (saldoF_Abs < 0.10) { status = "PLANO ACEITÁVEL"; cor = "#ffc107"; msg = "O plano do banco possui oscilação mínima aceitável."; }

			const dadosExibir = (visao === 'banco') ? banco : revisado;
			const tituloVisao = (visao === 'banco') ? "Plano do Banco (Auditado)" : "Plano Revisado (Correto)";

			area.innerHTML = `
				<div id="laudo-container" style="border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow:hidden;">
					<div style="background-color: #1a2a3a; padding: 30px; border-bottom: 4px solid #c5a059; text-align: center; color: white;">
						<img src="grafico.svg" alt="Dr. Lincoln Sposito" style="width: 250px;">
						<h2 style="font-family: 'Playfair Display', serif; margin-top:10px;">Laudo Pericial: Sistema ${nomeSistema}</h2>
					</div>
					
					<div style="padding: 30px;">
						<div class="info-box" style="border-left: 8px solid ${cor}; background: #fff5f5; padding: 25px; margin-bottom: 30px;">
							<h4 style="color: ${cor}; text-transform: uppercase; margin-top:0;">${status}</h4>
							<p style="color: #333;">${msg}</p>
							
							<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; border-top: 1px solid #f2dede; border-bottom: 1px solid #f2dede; padding: 15px 0;">
								<div><small>TOTAL PAGO (BANCO)</small><br><strong>R$ ${formatarMoeda(banco.tPmt)}</strong></div>
								<div><small>JUROS ACUMULADOS</small><br><strong>R$ ${formatarMoeda(banco.tJur)}</strong></div>
								<div><small>AMORTIZAÇÃO REAL</small><br><strong>R$ ${formatarMoeda(banco.tAmort)}</strong></div>
							</div>

							<p style="font-size: 0.95rem; line-height: 1.6;">
								<strong>Análise de Parâmetros:</strong> Pela taxa de ${(p.iNom*100).toFixed(10)}%, a ${nomeSistema === 'PRICE' ? 'parcela' : '1ª parcela'} deveria ser <strong>R$ ${formatarMoeda(banco.pmtRef)}</strong>. 
								O valor informado projeta uma taxa real de <strong>${(taxaReal*100).toFixed(10)}% a.m.</strong>
							</p>
							<p style="font-size: 1.1rem; margin-top: 15px; color: ${cor}; font-weight: bold;">
								${banco.saldoFinal < -0.01 ? `PAGAMENTO INDÉBITO DETECTADO: R$ ${formatarMoeda(Math.abs(banco.saldoFinal))}` : `RESÍDUO EM ABERTO: R$ ${formatarMoeda(banco.saldoFinal)}`}
							</p>
						</div>

						<h3 style="color: #1a2a3a; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">Exibindo: ${tituloVisao}</h3>
						<table class="table-pericia" style="width:100%; border-collapse: collapse;">
							<thead><tr><th>Nº</th><th>Parcela</th><th>Juros</th><th>Amortização</th><th>Saldo</th></tr></thead>
							<tbody>
								${dadosExibir.tabela.map(it => `
									<tr>
										<td>${it.n}</td>
										<td>R$ ${formatarMoeda(it.pmt)}</td>
										<td>R$ ${formatarMoeda(it.jur)}</td>
										<td>R$ ${formatarMoeda(it.amort)}</td>
										<td ${it.n === p.n && saldoF_Abs > 0.1 ? 'style="color:red; font-weight:bold;"' : ''}>R$ ${formatarMoeda(it.saldo)}</td>
									</tr>`).join('')}
								<tr style="background:#f8f9fa; font-weight:bold;">
									<td>TOTAIS</td><td>R$ ${formatarMoeda(dadosExibir.tPmt)}</td><td>R$ ${formatarMoeda(dadosExibir.tJur)}</td><td>R$ ${formatarMoeda(dadosExibir.tAmort)}</td><td>---</td>
								</tr>
							</tbody>
						</table>
						<div id="cta-pericial" style="margin-top: 40px; padding: 30px; background: #fdf8ef; border: 2px dashed #c5a059; border-radius: 8px; text-align: center;">
							<h3 style="font-family: 'Playfair Display', serif; color: #1a2a3a; margin-bottom: 15px;">Deseja uma análise jurídica detalhada deste contrato?</h3>
							<p style="color: #666; margin-bottom: 25px;">Nossa equipe de especialistas em direito bancário pode ajudar você a recuperar valores pagos indevidamente.</p>
							<a href="https://wa.me/11914612603" target="_blank" class="btn-primary" style="padding: 15px 30px; text-decoration: none; font-weight: bold; display: inline-block;">Falar com Dr Lincoln agora</a>
						</div>						
					</div>
				</div>`;
			area.scrollIntoView({ behavior: 'smooth' });
		}

		function calcularTaxaImplicita(pv, pmt, n, sistema) {
			if (sistema !== 'PRICE') {
				const amort = pv / n;
				return (pmt - amort) / pv;
			}
			let i = 0.01;
			for (let x = 0; x < 30; x++) {
				let f = pmt * (1 - Math.pow(1 + i, -n)) / i - pv;
				let df = pmt * (n * Math.pow(1 + i, -n - 1) * i - (1 - Math.pow(1 + i, -n))) / (i * i);
				i = i - f / (df || 1);
			}
			return i;
		}
	</script>
 -->

<!--	
<script>
    // --- SCRIPTS DE INTERFACE ---
    window.onload = function() {
        const hoje = new Date();
        const vencimento = new Date();
        vencimento.setDate(hoje.getDate() + 30);
        document.getElementById('dataCelebracao').value = hoje.toISOString().split('T')[0];
        document.getElementById('dataVencimento').value = vencimento.toISOString().split('T')[0];
        calcularCarencia();
    };

    function parseMoeda(v) { return parseFloat(v.replace(/\./g, '').replace(',', '.')) || 0; }
    
    // Suporte a 5 casas decimais na entrada
    function parsePercentual(v) { 
        if(!v) return 0;
        let limpo = v.replace('%', '').trim().replace(/\./g, '').replace(',', '.');
        return parseFloat(limpo) || 0; 
    }
    
    function formatarMoeda(v) { return v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    function calcularFinanciamento() {
        const principal = Math.max(0, parseMoeda(document.getElementById('valorBem').value) - parseMoeda(document.getElementById('valorEntrada').value));
        document.getElementById('valorPrincipal').value = formatarMoeda(principal);
        calcularTotalFinanciado();
    }

    function calcularTotalFinanciado() {
        const total = parseMoeda(document.getElementById('valorPrincipal').value) + parseMoeda(document.getElementById('despesas').value);
        document.getElementById('valorTotal').value = formatarMoeda(total);
    }

    function calcularCarencia() {
        const d1 = new Date(document.getElementById('dataCelebracao').value);
        const d2 = new Date(document.getElementById('dataVencimento').value);
        if (d1 && d2) document.getElementById('carencia').value = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));
    }

    document.querySelectorAll('.mask-money').forEach(i => i.addEventListener('blur', function() { 
        this.value = formatarMoeda(parseMoeda(this.value)); 
    }));

    document.querySelectorAll('.mask-percent').forEach(i => i.addEventListener('blur', function() { 
        let v = parsePercentual(this.value);
        if (v > 0) {
            this.value = v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 10 }) + '%'; 
        }
    }));

    // --- MOTOR DE CÁLCULO ---
    function processarCalculo() {
        try {
            const sistema = document.getElementById('sistema').value;
            const n = parseInt(document.getElementById('parcelas').value);
            const iNominal = parsePercentual(document.getElementById('taxaNominal').value) / 100;
            const pvPrincipal = parseMoeda(document.getElementById('valorPrincipal').value);
            const despesas = parseMoeda(document.getElementById('despesas').value);
            const pvTotal = pvPrincipal + despesas;
            const pmtInfo = parseMoeda(document.getElementById('valorParcelaInformado').value);
            const visao = document.querySelector('input[name="tipoVisao"]:checked').value;

            if (pvTotal <= 0 || n <= 0 || iNominal <= 0) { alert("Dados incompletos."); return; }

            let pmtCorretaNominal = 0;
            if (sistema === 'price') {
                pmtCorretaNominal = pvTotal * ( (iNominal * Math.pow(1 + iNominal, n)) / (Math.pow(1 + iNominal, n) - 1) );
            } else {
                pmtCorretaNominal = (pvTotal / n) + (pvTotal * iNominal);
            }
            
            // Newton-Raphson com alta precisão
            const taxaRealImplicita = (pmtInfo > 0) ? calcularTaxaImplicita(pvTotal, pmtInfo, n) : iNominal;

            let tabela = [];
            let saldo = pvTotal;
            let totalPmtReal = 0, totalJurosReal = 0, totalAmortReal = 0;
            let pmtParaUso = (visao === 'banco' && pmtInfo > 0) ? pmtInfo : pmtCorretaNominal;

            for (let i = 1; i <= n; i++) {
                let jurosNoMes = saldo * iNominal;
                let pmtNoMes = (sistema === 'sac' && visao === 'revisado') ? ((pvTotal / n) + jurosNoMes) : pmtParaUso;
                let amortizacaoNoMes = pmtNoMes - jurosNoMes;
                
                saldo -= amortizacaoNoMes;
                totalPmtReal += pmtNoMes;
                totalJurosReal += jurosNoMes;
                totalAmortReal += amortizacaoNoMes;
                
                tabela.push({ n: i, pmt: pmtNoMes, juros: jurosNoMes, amort: amortizacaoNoMes, saldo: saldo });
            }

            const cet = (Math.pow((totalPmtReal) / pvPrincipal, 1 / n) - 1);

            renderizarFinal(tabela, pvTotal, totalJurosReal, totalPmtReal, totalAmortReal, pmtCorretaNominal, pmtInfo, taxaRealImplicita, cet, iNominal, visao);
        } catch (e) { console.error(e); }
    }

    function calcularTaxaImplicita(pv, pmt, n) {
        let i = 0.01;
        for (let x = 0; x < 30; x++) {
            let f = pmt * (1 - Math.pow(1 + i, -n)) / i - pv;
            let df = pmt * (n * Math.pow(1 + i, -n - 1) * i - (1 - Math.pow(1 + i, -n))) / (i * i);
            i = i - f / (df || 1);
        }
        return i;
    }

    function renderizarFinal(tabela, pv, totalJuros, totalPmt, totalAmort, pmtCorreta, pmtInfo, taxaReal, cet, iNominal, visao) {
        const area = document.getElementById('resultado-area');
        area.style.display = 'block';
        const saldoFinal = tabela[tabela.length - 1].saldo;
        const saldoFinalAbs = Math.abs(saldoFinal);
        const tituloLaudo = visao === 'banco' ? "Auditoria: Plano do Banco (Inconsistência de Fluxo)" : "Plano Revisado: Rigor Matemático Nominal";

        area.innerHTML = `
            <div id="laudo-container" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #fff;">
                <div style="background-color: #1a2a3a; padding: 30px; border-bottom: 4px solid #c5a059; text-align: center;">
                    <img src="grafico.svg" alt="Dr. Lincoln Sposito" style="width: 280px; height: auto; filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.3));">
                    <h2 style="font-family: 'Playfair Display', serif; color: #ffffff; margin: 15px 0 5px 0; font-size: 1.8rem;">${tituloLaudo}</h2>
                    <p style="color: #c5a059; font-weight: 600; margin: 0; text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem;">Confronto de Dados Contratuais vs Execução Financeira</p>
                </div>
                <div style="padding: 30px;">
                    <div id="diagnostico-pericial"></div>
                    <div id="insights-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;"></div>
                    <div class="table-container" style="overflow-x: auto;">
                        <table id="tabela-amortizacao" class="table-pericia" style="width: 100%; border-collapse: collapse;"></table>
                    </div>
                </div>
            </div>
        `;

        if (pmtInfo > 0) {
            let statusPlano = "", corStatus = "", msgValidacao = "";

            if (saldoFinalAbs < 0.005) {
                statusPlano = "PLANO VALIDADO"; corStatus = "#28a745";
                msgValidacao = "O plano apresenta conformidade matemática. O saldo devedor tende a zero conforme esperado.";
            } else if (saldoFinalAbs < 0.10) {
                statusPlano = "PLANO ACEITÁVEL"; corStatus = "#ffc107";
                msgValidacao = "Diferença mínima detectada na 2ª casa decimal. Embora devesse tender a zero, a oscilação é aceitável.";
            } else {
                statusPlano = "INCONSISTÊNCIA DETECTADA"; corStatus = "#d9534f";
                msgValidacao = `Plano <strong>INCORRETO</strong> matematicamente. A divergência supera a ordem de grandeza permitida para arredondamentos.`;
            }

            document.getElementById('diagnostico-pericial').innerHTML = `
                <div class="info-box" style="border-left-color: ${corStatus}; background: #fff5f5; padding: 25px; margin-bottom: 25px; border-left-width: 8px;">
                    <h4 style="color: ${corStatus}; margin: 0 0 10px 0; text-transform: uppercase;">${statusPlano}</h4>
                    <p>${msgValidacao}</p>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; border-top: 1px solid #f2dede; border-bottom: 1px solid #f2dede; padding: 15px 0;">
                        <div><small>TOTAL PARCELAS</small><br><strong>R$ ${totalPmt.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></div>
                        <div><small>TOTAL JUROS</small><br><strong>R$ ${totalJuros.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></div>
                        <div><small>TOTAL AMORTIZADO</small><br><strong>R$ ${totalAmort.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></div>
                    </div>
                    <p style="font-size: 0.95rem;"><strong>Incoerência técnica:</strong> Taxa Nominal declarada de <strong>${(iNominal*100).toLocaleString('pt-BR', {minimumFractionDigits: 5})}%</strong> deveria gerar parcela de <strong>R$ ${pmtCorreta.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>.</p>
                    <p style="font-size: 1.1rem; margin-top: 15px; color: ${corStatus}; font-weight: bold;">
                        ${saldoFinal < -0.01 ? `PAGAMENTO INDÉBITO DETECTADO: R$ ${Math.abs(saldoFinal).toLocaleString('pt-BR', {minimumFractionDigits: 2})}` : `RESÍDUO EM ABERTO: R$ ${saldoFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`}
                    </p>
                </div>
            `;
        }

        document.getElementById('insights-cards').innerHTML = `
            <div class="info-box" style="border-left-color: #c5a059;"><strong>CET Real: ${(cet*100).toFixed(4)}%</strong><br><small>Custo Efetivo Mensal</small></div>
            <div class="info-box" style="border-left-color: #1a2a3a;"><strong>Taxa Implícita: ${(taxaReal*100).toLocaleString('pt-BR', {minimumFractionDigits: 5})}%</strong><br><small>Taxa real da parcela</small></div>
            <div class="info-box" style="border-left-color: #c5a059;"><strong>Total Pago: R$ ${totalPmt.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong><br><small>Soma global</small></div>
        `;

        let html = `<thead><tr><th style="text-align:center">Parcela</th><th>Prestação</th><th>Juros</th><th>Amortização</th><th>Saldo</th></tr></thead><tbody>`;
        tabela.forEach(it => {
            const styleS = (it.n === tabela.length && Math.abs(it.saldo) > 0.01) ? 'style="color: #d9534f; font-weight: bold;"' : '';
            html += `<tr><td style="text-align:center">${it.n}</td><td>${formatarMoeda(it.pmt)}</td><td>${formatarMoeda(it.juros)}</td><td>${formatarMoeda(it.amort)}</td><td ${styleS}>${formatarMoeda(it.saldo)}</td></tr>`;
        });
        html += `<tr style="background:#f8f9fa; font-weight:bold;"><td style="text-align:center">TOTAIS</td><td>${formatarMoeda(totalPmt)}</td><td>${formatarMoeda(totalJuros)}</td><td>${formatarMoeda(totalAmort)}</td><td>---</td></tr>`;
        
        document.getElementById('tabela-amortizacao').innerHTML = html + `</tbody>`;
        area.scrollIntoView({ behavior: 'smooth' });
    }
</script>
-->

<!--
    <script>
        // --- SCRIPTS DE INTERFACE ---
        window.onload = function() {
            const hoje = new Date();
            const vencimento = new Date();
            vencimento.setDate(hoje.getDate() + 30);
            document.getElementById('dataCelebracao').value = hoje.toISOString().split('T')[0];
            document.getElementById('dataVencimento').value = vencimento.toISOString().split('T')[0];
            calcularCarencia();
        };

        function parseMoeda(v) { return parseFloat(v.replace(/\./g, '').replace(',', '.')) || 0; }
        function parsePercentual(v) { return parseFloat(v.replace('%', '').replace(',', '.')) || 0; }
        function formatarMoeda(v) { return v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

        function calcularFinanciamento() {
            const principal = Math.max(0, parseMoeda(document.getElementById('valorBem').value) - parseMoeda(document.getElementById('valorEntrada').value));
            document.getElementById('valorPrincipal').value = formatarMoeda(principal);
            calcularTotalFinanciado();
        }

        function calcularTotalFinanciado() {
            const total = parseMoeda(document.getElementById('valorPrincipal').value) + parseMoeda(document.getElementById('despesas').value);
            document.getElementById('valorTotal').value = formatarMoeda(total);
        }

        function calcularCarencia() {
            const d1 = new Date(document.getElementById('dataCelebracao').value);
            const d2 = new Date(document.getElementById('dataVencimento').value);
            if (d1 && d2) document.getElementById('carencia').value = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));
        }

        document.querySelectorAll('.mask-money').forEach(i => i.addEventListener('blur', function() { this.value = formatarMoeda(parseMoeda(this.value)); }));
        document.querySelectorAll('.mask-percent').forEach(i => i.addEventListener('blur', function() { this.value = parsePercentual(this.value).toFixed(2).replace('.', ',') + '%'; }));

        // --- MOTOR DE CÁLCULO E RENDERIZAÇÃO ---
        function processarCalculo() {
			try {
				const sistema = document.getElementById('sistema').value;
				const n = parseInt(document.getElementById('parcelas').value);
				const iEfetiva = parsePercentual(document.getElementById('taxaEfetiva').value) / 100;
				const pvPrincipal = parseMoeda(document.getElementById('valorPrincipal').value);
				const pvTotal = pvPrincipal + parseMoeda(document.getElementById('despesas').value);
				const pmtInfo = parseMoeda(document.getElementById('valorParcelaInformado').value);
				const visao = document.querySelector('input[name="tipoVisao"]:checked').value;

				if (pvTotal <= 0 || n <= 0 || iEfetiva <= 0) { alert("Dados incompletos."); return; }

				// --- CENÁRIO REVISADO (O CORRETO) ---
				let pmtCorreta = 0;
				if (sistema === 'price') {
					pmtCorreta = pvTotal * ( (iEfetiva * Math.pow(1 + iEfetiva, n)) / (Math.pow(1 + iEfetiva, n) - 1) );
				} else {
					pmtCorreta = (pvTotal / n) + (pvTotal * iEfetiva); // 1ª parcela do SAC
				}

				// --- CENÁRIO DO BANCO (O INFORMADO) ---
				const taxaRealNaParcela = (pmtInfo > 0) ? calcularTaxaImplicita(pvTotal, pmtInfo, n) : iEfetiva;
				
				// Escolha de qual tabela montar
				let tabelaParaExibir = [];
				let saldo = pvTotal;
				let jurosAcumulados = 0;
				let taxaParaUso = (visao === 'banco' && pmtInfo > 0) ? taxaRealNaParcela : iEfetiva;
				let pmtParaUso = (visao === 'banco' && pmtInfo > 0) ? pmtInfo : pmtCorreta;

				for (let i = 1; i <= n; i++) {
					let jurosNoMes = saldo * taxaParaUso;
					let amortizacaoNoMes;
					let pmtNoMes;

					if (sistema === 'price') {
						pmtNoMes = pmtParaUso;
						amortizacaoNoMes = pmtNoMes - jurosNoMes;
					} else {
						amortizacaoNoMes = pvTotal / n;
						pmtNoMes = amortizacaoNoMes + jurosNoMes;
					}

					saldo -= amortizacaoNoMes;
					jurosAcumulados += jurosNoMes;
					tabelaParaExibir.push({ n: i, pmt: pmtNoMes, juros: jurosNoMes, amort: amortizacaoNoMes, saldo: Math.max(0, saldo) });
				}

				const cet = (Math.pow((pvPrincipal + jurosAcumulados + parseMoeda(document.getElementById('despesas').value)) / pvPrincipal, 1 / n) - 1);

				renderizarFinal(tabelaParaExibir, pvTotal, jurosAcumulados, pmtCorreta, pmtInfo, taxaRealNaParcela, cet, visao);
			} catch (e) { console.error(e); }
		}

        function calcularTaxaImplicita(pv, pmt, n) {
            let i = 0.01;
            for (let x = 0; x < 20; x++) {
                let f = pmt * (1 - Math.pow(1 + i, -n)) / i - pv;
                let df = pmt * (n * Math.pow(1 + i, -n - 1) * i - (1 - Math.pow(1 + i, -n))) / (i * i);
                i = i - f / (df || 1);
            }
            return i;
        }

		function renderizarFinal(tabela, pv, totalJuros, pmtCorreta, pmtInfo, taxaReal, cet, visao) {
			const area = document.getElementById('resultado-area');
			area.style.display = 'block';
			
			// Título dinâmico conforme a visão selecionada
			const tituloLaudo = visao === 'banco' ? "Simulação: Plano do Banco (Dados Informados)" : "Simulação: Plano Revisado (Cálculo Pericial)";

			// 1. Cabeçalho Estilizado (Cores do Index.html)
			area.innerHTML = `
				<div id="laudo-container" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #fff;">
					<div style="background-color: #1a2a3a; padding: 30px; border-bottom: 4px solid #c5a059; text-align: center;">
						<img src="grafico.svg" alt="Dr. Lincoln Sposito" style="width: 280px; height: auto; filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.3));">
						<h2 style="font-family: 'Playfair Display', serif; color: #ffffff; margin: 15px 0 5px 0; font-size: 1.8rem;">${tituloLaudo}</h2>
						<p style="color: #c5a059; font-weight: 600; margin: 0; text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem;">Laudo Técnico Preliminar de Amortização</p>
					</div>
					
					<div style="padding: 30px;">
						<div id="insights-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;"></div>
						<div id="resumo-financeiro"></div>
						<div class="table-container" style="overflow-x: auto;">
							<table id="tabela-amortizacao" class="table-pericia" style="width: 100%; border-collapse: collapse;"></table>
						</div>
						<div id="cta-final" style="text-align:center; padding:20px; margin-top:20px; border:1px dashed #c5a059;">
							<p>Precisa de um laudo oficial? <a href="index.html#contato" class="btn-primary" style="text-decoration:none;">Fale com o Dr. Lincoln</a></p>
						</div>
					</div>
				</div>
			`;

			// 2. Construção dos Insights Comparativos
			let insightTexto = "";
			if (pmtInfo > 0) {
				const diffParcela = pmtInfo - pmtCorreta;
				const diffJurosTotal = (pmtInfo * tabela.length) - (pmtCorreta * tabela.length);
				
				insightTexto = `
					<div class="info-box" style="grid-column: 1 / -1; border-left-color: #d9534f; background: #fff5f5; padding: 20px; margin-bottom: 20px;">
						<h4 style="color: #d9534f; margin-top: 0;">Diagnóstico de Divergência Técnica</h4>
						<p>Pelo valor da Taxa informada, o valor correto da parcela deveria ser <strong>R$ ${pmtCorreta.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>.</p>
						<p>Pelo valor da Parcela informada, a taxa nominal correta aplicada é de <strong>${(taxaReal * 100).toFixed(4)}% a.m.</strong></p>
						<p style="margin-top: 15px; border-top: 1px solid #f2dede; padding-top: 10px;">
							Desta forma, você está amortizando <strong>R$ ${Math.abs(diffParcela).toLocaleString('pt-BR', {minimumFractionDigits: 2})} a menos</strong> do que deveria por mês e pagando um excesso de <strong>R$ ${Math.abs(diffJurosTotal).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong> em juros ao final do contrato.
						</p>
					</div>
				`;
			}

			// 3. Preenchimento dos Cards de Info
			document.getElementById('insights-cards').innerHTML = insightTexto + `
				<div class="info-box" style="border-left-color: #c5a059;"><strong>CET: ${(cet*100).toFixed(4)}%</strong><br><small>Custo real mensal</small></div>
				<div class="info-box" style="border-left-color: #1a2a3a;"><strong>Total de Juros: R$ ${totalJuros.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong><br><small>Acumulado no período</small></div>
			`;

			// 4. Resumo Financeiro
			document.getElementById('resumo-financeiro').innerHTML = `
				<div style="background:#f8f9fa; padding:15px; border-radius:8px; display:flex; justify-content:space-around; margin-bottom:20px; border: 1px solid #eee;">
					<div>TOTAL PAGO: <strong>R$ ${(pv + totalJuros).toLocaleString('pt-BR')}</strong></div>
					<div>AMORTIZAÇÃO: <strong>R$ ${pv.toLocaleString('pt-BR')}</strong></div>
				</div>
			`;

			// 5. Preenchimento da Tabela
			let html = `<thead><tr><th style="text-align:center">Parcela</th><th>Prestação</th><th>Juros</th><th>Amortização</th><th>Saldo</th></tr></thead><tbody>`;
			tabela.forEach(it => {
				html += `<tr>
					<td style="text-align:center">${it.n}</td>
					<td>R$ ${it.pmt.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
					<td>R$ ${it.juros.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
					<td>R$ ${it.amort.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
					<td>R$ ${it.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
				</tr>`;
			});
			document.getElementById('tabela-amortizacao').innerHTML = html + `</tbody>`;

			// Scroll para o resultado
			area.scrollIntoView({ behavior: 'smooth' });
		}
    </script>
-->

<!--MODELO VALIDADO DO SAC E Price
<script>
    // --- 1. FUNÇÕES DE INTERFACE E MÁSCARAS ---
    window.onload = function() {
        const hoje = new Date();
        const vencimento = new Date();
        vencimento.setDate(hoje.getDate() + 30);
        document.getElementById('dataCelebracao').value = hoje.toISOString().split('T')[0];
        document.getElementById('dataVencimento').value = vencimento.toISOString().split('T')[0];
        calcularCarencia();
    };

    function parseMoeda(v) { return parseFloat(v.replace(/\./g, '').replace(',', '.')) || 0; }
    function parsePercentual(v) { 
        if(!v) return 0;
        let limpo = v.replace('%', '').trim().replace(/\./g, '').replace(',', '.');
        return parseFloat(limpo) || 0; 
    }
    function formatarMoeda(v) { return v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    function calcularFinanciamento() {
        const principal = Math.max(0, parseMoeda(document.getElementById('valorBem').value) - parseMoeda(document.getElementById('valorEntrada').value));
        document.getElementById('valorPrincipal').value = formatarMoeda(principal);
        calcularTotalFinanciado();
    }

    function calcularTotalFinanciado() {
        const total = parseMoeda(document.getElementById('valorPrincipal').value) + parseMoeda(document.getElementById('despesas').value);
        document.getElementById('valorTotal').value = formatarMoeda(total);
    }

    function calcularCarencia() {
        const d1 = new Date(document.getElementById('dataCelebracao').value);
        const d2 = new Date(document.getElementById('dataVencimento').value);
        if (d1 && d2) document.getElementById('carencia').value = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));
    }

    document.querySelectorAll('.mask-money').forEach(i => i.addEventListener('blur', function() { this.value = formatarMoeda(parseMoeda(this.value)); }));
    document.querySelectorAll('.mask-percent').forEach(i => i.addEventListener('blur', function() { 
        let v = parsePercentual(this.value);
        this.value = v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 10 }) + '%'; 
    }));
	
	document.getElementById('sistema').addEventListener('change', function() {
    const label = document.getElementById('labelParcela');
		if (this.value === 'sac') {
			label.innerHTML = 'Valor da <strong>1ª Parcela</strong> (Contrato)';
		} else {
			label.innerHTML = 'Valor da Parcela Fixa (Contrato)';
		}
	});

    // --- 2. MOTOR DE CÁLCULO (DISPATCHER) ---
    function processarCalculo() {
        try {
            const sistema = document.getElementById('sistema').value;
            const visao = document.querySelector('input[name="tipoVisao"]:checked').value;
            const p = {
                n: parseInt(document.getElementById('parcelas').value),
                iNom: parsePercentual(document.getElementById('taxaNominal').value) / 100,
                pvPrin: parseMoeda(document.getElementById('valorPrincipal').value),
                desp: parseMoeda(document.getElementById('despesas').value),
                pmtInfo: parseMoeda(document.getElementById('valorParcelaInformado').value)
            };
            p.pvTotal = p.pvPrin + p.desp;

            if (p.pvTotal <= 0 || p.n <= 0 || p.iNom <= 0) { alert("Dados incompletos."); return; }

            let auditoriaBanco, planoRevisado;

            if (sistema === 'price') {
                auditoriaBanco = motorPrice(p, 'banco');
                planoRevisado = motorPrice(p, 'revisado');
                renderizarLaudoUnificado(auditoriaBanco, planoRevisado, p, visao, "PRICE");
            } 
            else if (sistema === 'sac') {
                auditoriaBanco = motorSAC(p, 'banco');
                planoRevisado = motorSAC(p, 'revisado');
                renderizarLaudoUnificado(auditoriaBanco, planoRevisado, p, visao, "SAC");
            } 
            else {
                alert("Sistema ainda não encapsulado.");
            }

        } catch (e) { console.error(e); }
    }

    // --- 3. ENCAPSULAMENTO PRICE (SEM ALTERAÇÕES) ---
    function motorPrice(p, tipo) {
        let pmtCorreta = p.pvTotal * ( (p.iNom * Math.pow(1 + p.iNom, p.n)) / (Math.pow(1 + p.iNom, p.n) - 1) );
        let pmtUso = (tipo === 'banco' && p.pmtInfo > 0) ? p.pmtInfo : pmtCorreta;
        let saldo = p.pvTotal, tPmt = 0, tJur = 0, tAmort = 0, tabela = [];

        for (let i = 1; i <= p.n; i++) {
            let jur = saldo * p.iNom;
            let amort = pmtUso - jur;
            saldo -= amort;
            tPmt += pmtUso; tJur += jur; tAmort += amort;
            tabela.push({ n: i, pmt: pmtUso, jur, amort, saldo });
        }
        return { tabela, pmtRef: pmtCorreta, tPmt, tJur, tAmort, saldoFinal: saldo };
    }

    // --- 4. ENCAPSULAMENTO SAC (CENÁRIO B - PROJEÇÃO DE ERRO) ---
    function motorSAC(p, tipo) {
        const amortConstante = p.pvTotal / p.n;
        const pmtPrimeiraCorreta = amortConstante + (p.pvTotal * p.iNom);
        const decrescimoMensal = amortConstante * p.iNom;

        // Na auditoria do banco, se houver pmtInfo, usamos como base da 1ª parcela e projetamos o SAC
        let pmtBase = (tipo === 'banco' && p.pmtInfo > 0) ? p.pmtInfo : pmtPrimeiraCorreta;
        
        let saldo = p.pvTotal, tPmt = 0, tJur = 0, tAmort = 0, tabela = [];

        for (let i = 1; i <= p.n; i++) {
            let jur = saldo * p.iNom;
            // No SAC, a parcela decresce a cada mês. 
            // Projetamos o erro inicial (pmtBase) mantendo a estrutura decrescente do método.
            let pmtNoMes = pmtBase - (decrescimoMensal * (i - 1));
            let amort = pmtNoMes - jur;
            
            saldo -= amort;
            tPmt += pmtNoMes; tJur += jur; tAmort += amort;
            tabela.push({ n: i, pmt: pmtNoMes, jur, amort, saldo });
        }
        return { tabela, pmtRef: pmtPrimeiraCorreta, tPmt, tJur, tAmort, saldoFinal: saldo };
    }

    // --- 5. RENDERIZAÇÃO UNIFICADA ---
    function renderizarLaudoUnificado(banco, revisado, p, visao, nomeSistema) {
        const area = document.getElementById('resultado-area');
        area.style.display = 'block';
        
        const saldoF_Abs = Math.abs(banco.saldoFinal);
        const taxaReal = calcularTaxaImplicita(p.pvTotal, p.pmtInfo, p.n, nomeSistema);
        
        let status = "INCONSISTÊNCIA DETECTADA", cor = "#d9534f", msg = "O plano do banco é matematicamente INCORRETO.";
        if (saldoF_Abs < 0.005) { status = "PLANO VALIDADO"; cor = "#28a745"; msg = "O plano do banco apresenta conformidade técnica."; }
        else if (saldoF_Abs < 0.10) { status = "PLANO ACEITÁVEL"; cor = "#ffc107"; msg = "O plano do banco possui oscilação mínima aceitável."; }

        const dadosExibir = (visao === 'banco') ? banco : revisado;
        const tituloVisao = (visao === 'banco') ? "Plano do Banco (Auditado)" : "Plano Revisado (Correto)";

        area.innerHTML = `
            <div id="laudo-container" style="border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow:hidden;">
                <div style="background-color: #1a2a3a; padding: 30px; border-bottom: 4px solid #c5a059; text-align: center; color: white;">
                    <img src="grafico.svg" alt="Dr. Lincoln Sposito" style="width: 250px;">
                    <h2 style="font-family: 'Playfair Display', serif; margin-top:10px;">Laudo Pericial: Sistema ${nomeSistema}</h2>
                </div>
                
                <div style="padding: 30px;">
                    <div class="info-box" style="border-left: 8px solid ${cor}; background: #fff5f5; padding: 25px; margin-bottom: 30px;">
                        <h4 style="color: ${cor}; text-transform: uppercase; margin-top:0;">${status}</h4>
                        <p style="color: #333;">${msg}</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; border-top: 1px solid #f2dede; border-bottom: 1px solid #f2dede; padding: 15px 0;">
                            <div><small>TOTAL PAGO (BANCO)</small><br><strong>R$ ${formatarMoeda(banco.tPmt)}</strong></div>
                            <div><small>JUROS ACUMULADOS</small><br><strong>R$ ${formatarMoeda(banco.tJur)}</strong></div>
                            <div><small>AMORTIZAÇÃO REAL</small><br><strong>R$ ${formatarMoeda(banco.tAmort)}</strong></div>
                        </div>

                        <p style="font-size: 0.95rem; line-height: 1.6;">
                            <strong>Análise de Parâmetros:</strong> Pela taxa de ${(p.iNom*100).toFixed(10)}%, a ${nomeSistema === 'SAC' ? '1ª parcela' : 'parcela'} deveria ser <strong>R$ ${formatarMoeda(banco.pmtRef)}</strong>. 
                            O valor informado projeta uma taxa real de <strong>${(taxaReal*100).toFixed(10)}% a.m.</strong>
                        </p>
                        <p style="font-size: 1.1rem; margin-top: 15px; color: ${cor}; font-weight: bold;">
                            ${banco.saldoFinal < -0.01 ? `PAGAMENTO INDÉBITO DETECTADO: R$ ${formatarMoeda(Math.abs(banco.saldoFinal))}` : `RESÍDUO EM ABERTO: R$ ${formatarMoeda(banco.saldoFinal)}`}
                        </p>
                    </div>

                    <h3 style="color: #1a2a3a; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">Exibindo: ${tituloVisao}</h3>
                    <table class="table-pericia" style="width:100%; border-collapse: collapse;">
                        <thead><tr><th>Nº</th><th>Parcela</th><th>Juros</th><th>Amortização</th><th>Saldo</th></tr></thead>
                        <tbody>
                            ${dadosExibir.tabela.map(it => `
                                <tr>
                                    <td>${it.n}</td>
                                    <td>R$ ${formatarMoeda(it.pmt)}</td>
                                    <td>R$ ${formatarMoeda(it.jur)}</td>
                                    <td>R$ ${formatarMoeda(it.amort)}</td>
                                    <td ${it.n === p.n && saldoF_Abs > 0.1 ? 'style="color:red; font-weight:bold;"' : ''}>R$ ${formatarMoeda(it.saldo)}</td>
                                </tr>`).join('')}
                            <tr style="background:#f8f9fa; font-weight:bold;">
                                <td>TOTAIS</td><td>R$ ${formatarMoeda(dadosExibir.tPmt)}</td><td>R$ ${formatarMoeda(dadosExibir.tJur)}</td><td>R$ ${formatarMoeda(dadosExibir.tAmort)}</td><td>---</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>`;
        area.scrollIntoView({ behavior: 'smooth' });
    }

    function calcularTaxaImplicita(pv, pmt, n, sistema) {
        if (sistema === 'SAC') {
            // No SAC, a taxa implícita baseada na 1ª parcela é linear: (PMT1 - AmortConstante) / PV
            const amort = pv / n;
            return (pmt - amort) / pv;
        }
        // Newton-Raphson para Price
        let i = 0.01;
        for (let x = 0; x < 30; x++) {
            let f = pmt * (1 - Math.pow(1 + i, -n)) / i - pv;
            let df = pmt * (n * Math.pow(1 + i, -n - 1) * i - (1 - Math.pow(1 + i, -n))) / (i * i);
            i = i - f / (df || 1);
        }
        return i;
    }
</script>	
-->
<!--FUNÇÃO base PRICE
 <script>
    // --- 1. FUNÇÕES DE INTERFACE E MÁSCARAS ---
    window.onload = function() {
        const hoje = new Date();
        const vencimento = new Date();
        vencimento.setDate(hoje.getDate() + 30);
        document.getElementById('dataCelebracao').value = hoje.toISOString().split('T')[0];
        document.getElementById('dataVencimento').value = vencimento.toISOString().split('T')[0];
        calcularCarencia();
    };

    function parseMoeda(v) { return parseFloat(v.replace(/\./g, '').replace(',', '.')) || 0; }
    function parsePercentual(v) { 
        if(!v) return 0;
        let limpo = v.replace('%', '').trim().replace(/\./g, '').replace(',', '.');
        return parseFloat(limpo) || 0; 
    }
    function formatarMoeda(v) { return v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    function calcularFinanciamento() {
        const principal = Math.max(0, parseMoeda(document.getElementById('valorBem').value) - parseMoeda(document.getElementById('valorEntrada').value));
        document.getElementById('valorPrincipal').value = formatarMoeda(principal);
        calcularTotalFinanciado();
    }

    function calcularTotalFinanciado() {
        const total = parseMoeda(document.getElementById('valorPrincipal').value) + parseMoeda(document.getElementById('despesas').value);
        document.getElementById('valorTotal').value = formatarMoeda(total);
    }

    function calcularCarencia() {
        const d1 = new Date(document.getElementById('dataCelebracao').value);
        const d2 = new Date(document.getElementById('dataVencimento').value);
        if (d1 && d2) document.getElementById('carencia').value = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));
    }

    document.querySelectorAll('.mask-money').forEach(i => i.addEventListener('blur', function() { this.value = formatarMoeda(parseMoeda(this.value)); }));
    document.querySelectorAll('.mask-percent').forEach(i => i.addEventListener('blur', function() { 
        let v = parsePercentual(this.value);
        this.value = v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 10 }) + '%'; 
    }));

    // --- 2. MOTOR DE CÁLCULO (DISPATCHER) ---
    function processarCalculo() {
        try {
            const sistema = document.getElementById('sistema').value;
            const visao = document.querySelector('input[name="tipoVisao"]:checked').value;
            const p = {
                n: parseInt(document.getElementById('parcelas').value),
                iNom: parsePercentual(document.getElementById('taxaNominal').value) / 100,
                pvPrin: parseMoeda(document.getElementById('valorPrincipal').value),
                desp: parseMoeda(document.getElementById('despesas').value),
                pmtInfo: parseMoeda(document.getElementById('valorParcelaInformado').value)
            };
            p.pvTotal = p.pvPrin + p.desp;

            if (p.pvTotal <= 0 || p.n <= 0 || p.iNom <= 0) { alert("Dados incompletos."); return; }

            // Encapsulamento: Chamada conforme o sistema selecionado
            if (sistema === 'price') {
                const auditoriaBanco = motorPrice(p, 'banco');
                const planoRevisado = motorPrice(p, 'revisado');
                renderizarLaudoUnificado(auditoriaBanco, planoRevisado, p, visao, "PRICE");
            } else {
                alert("Sistema " + sistema.toUpperCase() + " ainda em fase de implementação.");
            }

        } catch (e) { console.error(e); }
    }

    // --- 3. ENCAPSULAMENTO ESPECÍFICO SISTEMA PRICE ---
    function motorPrice(p, tipo) {
        // Cálculo da PMT correta via fórmula padrão Price
        let pmtCorreta = p.pvTotal * ( (p.iNom * Math.pow(1 + p.iNom, p.n)) / (Math.pow(1 + p.iNom, p.n) - 1) );
        
        let pmtUso = (tipo === 'banco' && p.pmtInfo > 0) ? p.pmtInfo : pmtCorreta;
        let saldo = p.pvTotal, tPmt = 0, tJur = 0, tAmort = 0, tabela = [];

        for (let i = 1; i <= p.n; i++) {
            let jur = saldo * p.iNom;
            let amort = pmtUso - jur;
            saldo -= amort;
            tPmt += pmtUso; tJur += jur; tAmort += amort;
            tabela.push({ n: i, pmt: pmtUso, jur, amort, saldo });
        }
        return { tabela, pmtRef: pmtCorreta, tPmt, tJur, tAmort, saldoFinal: saldo };
    }

    // --- 4. RENDERIZAÇÃO UNIFICADA ---
    function renderizarLaudoUnificado(banco, revisado, p, visao, nomeSistema) {
        const area = document.getElementById('resultado-area');
        area.style.display = 'block';
        
        const saldoF_Abs = Math.abs(banco.saldoFinal);
        const taxaReal = calcularTaxaImplicita(p.pvTotal, p.pmtInfo, p.n);
        
        let status = "INCONSISTÊNCIA DETECTADA", cor = "#d9534f", msg = "O plano do banco é matematicamente INCORRETO.";
        if (saldoF_Abs < 0.005) { status = "PLANO VALIDADO"; cor = "#28a745"; msg = "O plano do banco apresenta conformidade técnica."; }
        else if (saldoF_Abs < 0.10) { status = "PLANO ACEITÁVEL"; cor = "#ffc107"; msg = "O plano do banco possui oscilação mínima aceitável."; }

        const dadosExibir = (visao === 'banco') ? banco : revisado;
        const tituloVisao = (visao === 'banco') ? "Plano do Banco (Informado)" : "Plano Revisado (Correto)";

        area.innerHTML = `
            <div id="laudo-container" style="border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow:hidden;">
                <div style="background-color: #1a2a3a; padding: 30px; border-bottom: 4px solid #c5a059; text-align: center; color: white;">
                    <img src="grafico.svg" alt="Dr. Lincoln Sposito" style="width: 250px;">
                    <h2 style="font-family: 'Playfair Display', serif; margin-top:10px;">Laudo de Auditoria: Sistema ${nomeSistema}</h2>
                </div>
                
                <div style="padding: 30px;">
                    <div class="info-box" style="border-left: 8px solid ${cor}; background: #fff5f5; padding: 25px; margin-bottom: 30px;">
                        <h4 style="color: ${cor}; text-transform: uppercase; margin-top:0;">${status}</h4>
                        <p style="color: #333;">${msg}</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; border-top: 1px solid #f2dede; border-bottom: 1px solid #f2dede; padding: 15px 0;">
                            <div><small>TOTAL PARCELAS</small><br><strong>R$ ${formatarMoeda(banco.tPmt)}</strong></div>
                            <div><small>TOTAL JUROS</small><br><strong>R$ ${formatarMoeda(banco.tJur)}</strong></div>
                            <div><small>TOTAL AMORTIZADO</small><br><strong>R$ ${formatarMoeda(banco.tAmort)}</strong></div>
                        </div>

                        <p style="font-size: 0.95rem; line-height: 1.6;">
                            <strong>Análise Técnica:</strong> Para a taxa nominal de ${(p.iNom*100).toFixed(10)}%, a parcela deveria ser <strong>R$ ${formatarMoeda(banco.pmtRef)}</strong>. 
                            A parcela informada projeta uma taxa real de <strong>${(taxaReal*100).toFixed(10)}% a.m.</strong>
                        </p>
                        <p style="font-size: 1.1rem; margin-top: 15px; color: ${cor}; font-weight: bold;">
                            ${banco.saldoFinal < -0.01 ? `PAGAMENTO INDÉBITO DETECTADO: R$ ${formatarMoeda(Math.abs(banco.saldoFinal))}` : `RESÍDUO EM ABERTO: R$ ${formatarMoeda(banco.saldoFinal)}`}
                        </p>
                    </div>

                    <h3 style="color: #1a2a3a; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">Exibindo: ${tituloVisao}</h3>
                    <table class="table-pericia" style="width:100%; border-collapse: collapse;">
                        <thead><tr><th>Nº</th><th>Parcela</th><th>Juros</th><th>Amortização</th><th>Saldo</th></tr></thead>
                        <tbody>
                            ${dadosExibir.tabela.map(it => `
                                <tr>
                                    <td>${it.n}</td>
                                    <td>R$ ${formatarMoeda(it.pmt)}</td>
                                    <td>R$ ${formatarMoeda(it.jur)}</td>
                                    <td>R$ ${formatarMoeda(it.amort)}</td>
                                    <td ${it.n === p.n && saldoF_Abs > 0.1 ? 'style="color:red; font-weight:bold;"' : ''}>R$ ${formatarMoeda(it.saldo)}</td>
                                </tr>`).join('')}
                            <tr style="background:#f8f9fa; font-weight:bold;">
                                <td>TOTAIS</td><td>R$ ${formatarMoeda(dadosExibir.tPmt)}</td><td>R$ ${formatarMoeda(dadosExibir.tJur)}</td><td>R$ ${formatarMoeda(dadosExibir.tAmort)}</td><td>---</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>`;
        area.scrollIntoView({ behavior: 'smooth' });
    }

    function calcularTaxaImplicita(pv, pmt, n) {
        let i = 0.01;
        for (let x = 0; x < 30; x++) {
            let f = pmt * (1 - Math.pow(1 + i, -n)) / i - pv;
            let df = pmt * (n * Math.pow(1 + i, -n - 1) * i - (1 - Math.pow(1 + i, -n))) / (i * i);
            i = i - f / (df || 1);
        }
        return i;
    }
</script> -->
<!-- <script>
    // --- FUNÇÕES DE INTERFACE ---
    window.onload = function() {
        const hoje = new Date();
        const vencimento = new Date();
        vencimento.setDate(hoje.getDate() + 30);
        document.getElementById('dataCelebracao').value = hoje.toISOString().split('T')[0];
        document.getElementById('dataVencimento').value = vencimento.toISOString().split('T')[0];
        calcularCarencia();
    };

    function parseMoeda(v) { return parseFloat(v.replace(/\./g, '').replace(',', '.')) || 0; }
    function parsePercentual(v) { 
        if(!v) return 0;
        let limpo = v.replace('%', '').trim().replace(/\./g, '').replace(',', '.');
        return parseFloat(limpo) || 0; 
    }
    function formatarMoeda(v) { return v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    function calcularFinanciamento() {
        const principal = Math.max(0, parseMoeda(document.getElementById('valorBem').value) - parseMoeda(document.getElementById('valorEntrada').value));
        document.getElementById('valorPrincipal').value = formatarMoeda(principal);
        calcularTotalFinanciado();
    }

    function calcularTotalFinanciado() {
        const total = parseMoeda(document.getElementById('valorPrincipal').value) + parseMoeda(document.getElementById('despesas').value);
        document.getElementById('valorTotal').value = formatarMoeda(total);
    }

    function calcularCarencia() {
        const d1 = new Date(document.getElementById('dataCelebracao').value);
        const d2 = new Date(document.getElementById('dataVencimento').value);
        if (d1 && d2) document.getElementById('carencia').value = Math.ceil(Math.abs(d2 - d1) / (1000 * 60 * 60 * 24));
    }

    document.querySelectorAll('.mask-money').forEach(i => i.addEventListener('blur', function() { this.value = formatarMoeda(parseMoeda(this.value)); }));
    document.querySelectorAll('.mask-percent').forEach(i => i.addEventListener('blur', function() { 
        let v = parsePercentual(this.value);
        this.value = v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 10 }) + '%'; 
    }));

    // --- MOTOR DE CÁLCULO ENCAPSULADO ---
    function processarCalculo() {
        try {
            const sistema = document.getElementById('sistema').value;
            const visao = document.querySelector('input[name="tipoVisao"]:checked').value;
            const p = {
                n: parseInt(document.getElementById('parcelas').value),
                iNom: parsePercentual(document.getElementById('taxaNominal').value) / 100,
                pvPrin: parseMoeda(document.getElementById('valorPrincipal').value),
                desp: parseMoeda(document.getElementById('despesas').value),
                pmtInfo: parseMoeda(document.getElementById('valorParcelaInformado').value)
            };
            p.pvTotal = p.pvPrin + p.desp;

            if (p.pvTotal <= 0 || p.n <= 0 || p.iNom <= 0) { alert("Preencha os dados básicos."); return; }

            // 1. AUDITORIA DO PLANO DO BANCO (Sempre calculada como base)
            const auditoriaBanco = calcularPlano(p, sistema, 'banco');
            
            // 2. CÁLCULO DO PLANO REVISADO
            const planoRevisado = calcularPlano(p, sistema, 'revisado');

            // 3. APRESENTAÇÃO CONSOLIDADA
            renderizarLaudoUnificado(auditoriaBanco, planoRevisado, p, visao);

        } catch (e) { console.error(e); }
    }

    function calcularPlano(p, sistema, tipo) {
        let pmtPadrao = 0;
        if (sistema === 'price') {
            pmtPadrao = p.pvTotal * ( (p.iNom * Math.pow(1 + p.iNom, p.n)) / (Math.pow(1 + p.iNom, p.n) - 1) );
        } else {
            pmtPadrao = (p.pvTotal / p.n) + (p.pvTotal * p.iNom); // 1ª Parcela SAC
        }

        let pmtUso = (tipo === 'banco' && p.pmtInfo > 0) ? p.pmtInfo : pmtPadrao;
        let saldo = p.pvTotal, tPmt = 0, tJur = 0, tAmort = 0, tabela = [];

        for (let i = 1; i <= p.n; i++) {
            let jur = saldo * p.iNom;
            let pmtMes = (sistema === 'sac' && tipo === 'revisado') ? ((p.pvTotal / p.n) + jur) : pmtUso;
            let amort = pmtMes - jur;
            saldo -= amort;
            tPmt += pmtMes; tJur += jur; tAmort += amort;
            tabela.push({ n: i, pmt: pmtMes, jur, amort, saldo });
        }
        return { tabela, pmtRef: pmtPadrao, tPmt, tJur, tAmort, saldoFinal: saldo };
    }

    function renderizarLaudoUnificado(banco, revisado, p, visao) {
        const area = document.getElementById('resultado-area');
        area.style.display = 'block';
        
        // Dados para o Diagnóstico (Sempre baseados no Banco)
        const saldoF_Abs = Math.abs(banco.saldoFinal);
        const taxaReal = calcularTaxaImplicita(p.pvTotal, p.pmtInfo, p.n);
        
        let status = "INCONSISTÊNCIA DETECTADA", cor = "#d9534f", msg = "O plano do banco é matematicamente INCORRETO.";
        if (saldoF_Abs < 0.005) { status = "PLANO VALIDADO"; cor = "#28a745"; msg = "O plano do banco apresenta conformidade técnica."; }
        else if (saldoF_Abs < 0.10) { status = "PLANO ACEITÁVEL"; cor = "#ffc107"; msg = "O plano do banco possui oscilação mínima aceitável."; }

        const dadosExibir = (visao === 'banco') ? banco : revisado;
        const tituloVisao = (visao === 'banco') ? "Plano do Banco (Dados Informados)" : "Plano Revisado (Cálculo Pericial)";

        area.innerHTML = `
            <div id="laudo-container" style="border: 1px solid #ddd; border-radius: 8px; background: #fff; overflow:hidden;">
                <div style="background-color: #1a2a3a; padding: 30px; border-bottom: 4px solid #c5a059; text-align: center; color: white;">
                    <img src="grafico.svg" alt="Dr. Lincoln Sposito" style="width: 250px;">
                    <h2 style="font-family: 'Playfair Display', serif; margin-top:10px;">Laudo de Auditoria e Revisão Pericial</h2>
                </div>
                
                <div style="padding: 30px;">
                    <div class="info-box" style="border-left: 8px solid ${cor}; background: #fff5f5; padding: 25px; margin-bottom: 30px;">
                        <h4 style="color: ${cor}; text-transform: uppercase; margin-top:0;">${status}</h4>
                        <p style="color: #333;">${msg}</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; border-top: 1px solid #f2dede; border-bottom: 1px solid #f2dede; padding: 15px 0;">
                            <div><small>TOTAL PARCELAS</small><br><strong>R$ ${formatarMoeda(banco.tPmt)}</strong></div>
                            <div><small>TOTAL JUROS</small><br><strong>R$ ${formatarMoeda(banco.tJur)}</strong></div>
                            <div><small>TOTAL AMORTIZADO</small><br><strong>R$ ${formatarMoeda(banco.tAmort)}</strong></div>
                        </div>

                        <p style="font-size: 0.95rem; line-height: 1.6;">
                            <strong>Incoerência Técnica Detectada:</strong> Para a taxa nominal de ${(p.iNom*100).toFixed(10)}%, a parcela deveria ser <strong>R$ ${formatarMoeda(banco.pmtRef)}</strong>. 
                            A parcela cobrada projeta uma taxa real de <strong>${(taxaReal*100).toFixed(10)}% a.m.</strong>
                        </p>
                        <p style="font-size: 1.1rem; margin-top: 15px; color: ${cor}; font-weight: bold;">
                            ${banco.saldoFinal < -0.01 ? `PAGAMENTO INDÉBITO DETECTADO: R$ ${formatarMoeda(Math.abs(banco.saldoFinal))}` : `RESÍDUO EM ABERTO: R$ ${formatarMoeda(banco.saldoFinal)}`}
                        </p>
                    </div>

                    <h3 style="color: #1a2a3a; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">Exibindo: ${tituloVisao}</h3>
                    <table class="table-pericia" style="width:100%; border-collapse: collapse;">
                        <thead><tr><th>Nº</th><th>Parcela</th><th>Juros</th><th>Amortização</th><th>Saldo</th></tr></thead>
                        <tbody>
                            ${dadosExibir.tabela.map(it => `
                                <tr>
                                    <td>${it.n}</td>
                                    <td>R$ ${formatarMoeda(it.pmt)}</td>
                                    <td>R$ ${formatarMoeda(it.jur)}</td>
                                    <td>R$ ${formatarMoeda(it.amort)}</td>
                                    <td>R$ ${formatarMoeda(it.saldo)}</td>
                                </tr>`).join('')}
                            <tr style="background:#f8f9fa; font-weight:bold;">
                                <td>TOTAIS</td><td>R$ ${formatarMoeda(dadosExibir.tPmt)}</td><td>R$ ${formatarMoeda(dadosExibir.tJur)}</td><td>R$ ${formatarMoeda(dadosExibir.tAmort)}</td><td>---</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>`;
        area.scrollIntoView({ behavior: 'smooth' });
    }

    function calcularTaxaImplicita(pv, pmt, n) {
        let i = 0.01;
        for (let x = 0; x < 30; x++) {
            let f = pmt * (1 - Math.pow(1 + i, -n)) / i - pv;
            let df = pmt * (n * Math.pow(1 + i, -n - 1) * i - (1 - Math.pow(1 + i, -n))) / (i * i);
            i = i - f / (df || 1);
        }
        return i;
    }
</script> -->